<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Conversation Explorer</title>
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
    }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: var(--light-bg);
      color: var(--text-color);
      margin: 20px;
      padding: 20px;
      max-width: 1200px;
    }
    #logo-container { text-align: center; margin-bottom: 20px; }
    #logo { width: 300px; }
    h1 { color: var(--text-color); }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 24px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 20px 24px;
      align-items: start;
    }
    label { font-weight: 600; color: var(--text-color); margin-bottom: 6px; display: block; }
    select, input, button {
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 10px;
      font-size: 14px;
      background: var(--card-bg);
    }
    button {
      background: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background 0.2s;
      font-weight: 600;
    }
    button:hover { background: var(--secondary-color); }
    .inline {
      display: grid;
      grid-template-columns: 1fr auto 1fr;
      align-items: center;
      gap: 12px;
    }
    .inline span { color: var(--text-light); text-align: center; }
    .full-width-btn { width: 100%; padding: 14px; margin-top: 12px; font-size: 16px; }
    .user-info {
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      padding: 10px 16px;
      background: transparent;
    }
    details {
      background: var(--light-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 16px;
      margin: 12px 0;
    }
    details summary {
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      color: var(--text-color);
    }
    .journey-timeline { margin-top: 10px; padding-left: 16px; border-left: 3px solid var(--primary-color); }
    .journey-step { margin-bottom: 20px; position: relative; }
    .journey-step:before {
      content: '';
      position: absolute;
      left: -26px;
      top: 0;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary-color);
    }
    .step-header { font-weight: bold; color: var(--secondary-color); margin-bottom: 8px; }
    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 12px;
      margin: 12px 0;
    }
    .info-item { display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 4px 0; }
    .info-label { font-weight: 600; color: var(--text-color); }
    .info-value { color: var(--text-color); text-align: right; }
    .transcript-summary {
      border: 2px solid var(--primary-color);
      border-radius: 10px;
      padding: 16px;
      margin: 12px 0 24px;
      background: #ffffff;
    }
    .t-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 8px 16px;
      margin-bottom: 16px;
    }
    .t-kv { display: flex; justify-content: space-between; gap: 12px; }
    .t-kv .k { font-weight: 600; }
    .transcript-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
    }
    .transcript-table th {
      background: var(--primary-color);
      color: #fff;
      padding: 8px;
      font-weight: 600;
      text-align: left;
    }
    .transcript-table td {
      border-bottom: 1px solid var(--border-color);
      padding: 8px;
      vertical-align: top;
    }
    .transcript-table tr:nth-child(even) { background: #f9f9f9; }
    .sentiment-positive { color: #22c55e; font-weight: bold; }
    .sentiment-negative { color: #ef4444; font-weight: bold; }
    .sentiment-neutral { color: var(--text-light); }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>
  <h1>Conversation Explorer</h1>

  <div id="mainContent" class="card">
    <div class="controls">
      <div>
        <label for="agentSelect">Select Agent</label>
        <select id="agentSelect"><option>Loading users...</option></select>
        <input id="agentFilter" type="text" placeholder="Filter users by name"/>
        <div class="user-info" id="selectedAgentInfo" style="display:none;">
          <strong>Selected Agent:</strong> <span id="selectedAgentName">None</span>
        </div>
      </div>
      <div>
        <label>Date Range</label>
        <div class="inline">
          <input id="fromDate" type="date" />
          <span>to</span>
          <input id="toDate" type="date" />
        </div>
        <label style="margin-top: 8px;">
          <input type="checkbox" id="autoChunk" checked /> Auto-split large date ranges
        </label>
      </div>
    </div>
    <button id="fetchBtn" class="full-width-btn">Fetch Conversations</button>

    <div id="resultsSection" style="display:none;">
      <div id="results"></div>
    </div>
  </div>

  <script>
    const CONFIG = {
      clientId: 'd4529142-7340-4cd8-a9f9-f3a4d25670df',
      redirectUri: 'https://gmcglynn88.github.io/ConversationExplorer/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    const state = { token: null, selectedAgent: null, convIndex: {} };
    const $ = (id) => document.getElementById(id);

    window.onload = () => {
      $('agentSelect').innerHTML = '<option value="1">Gerard McGlynn</option>';
      $('fromDate').value = '2025-09-01';
      $('toDate').value = '2025-09-05';
      $('fetchBtn').onclick = showDemoConversation;
      state.token = 'demo';
    };

    function showDemoConversation() {
      $('resultsSection').style.display = 'block';
      const conversation = {
        conversationId: 'abc-123',
        conversationStart: '2025-09-23T12:02:00Z',
        conversationEnd: '2025-09-23T12:09:00Z',
        participants: [
          { purpose: 'customer', sessions: [{ sessionId: 'sess-456', mediaType: 'voice' }] },
          { purpose: 'user', userId: '1', name: 'Gerard McGlynn' }
        ]
      };

      $('results').innerHTML = `
        <details open>
          <summary><strong>${conversation.conversationId}</strong> - ${new Date(conversation.conversationStart).toLocaleString()} (3 participants)</summary>
          <div class="journey-timeline">
            <div class="journey-step">
              <div class="step-header">Step 1: <span class="info-label">Customer Joined</span></div>
              <div class="info-grid">
                <div class="info-item"><span class="info-label">Participant Type:</span><span class="info-value">Customer</span></div>
                <div class="info-item"><span class="info-label">Start Time:</span><span class="info-value">${new Date(conversation.conversationStart).toLocaleString()}</span></div>
              </div>
            </div>
          </div>
          <div class="transcript-wrapper" id="transcript-wrapper-${conversation.conversationId}">
            <button onclick="getTranscriptForConversation('${conversation.conversationId}', 'sess-456')" style="margin-top:12px;">Get Transcript</button>
            <div id="transcript-${conversation.conversationId}"></div>
          </div>
        </details>
      `;
    }

    async function getTranscriptForConversation(conversationId, sessionId) {
      const el = document.querySelector(`#transcript-${conversationId}`);
      el.innerHTML = '<div class="muted">Fetching transcript...</div>';

      // Demo fake transcript data
      const transcript = [
        { milliseconds: 7000, participantPurpose: 'Internal', decoratedText: "Thank you for calling, how can I help?", sentiment: 0.8 },
        { milliseconds: 29000, participantPurpose: 'External', decoratedText: "Hi, I need help with my account.", sentiment: -0.2 },
        { milliseconds: 60000, participantPurpose: 'Internal', decoratedText: "Sure, can you verify your details?", sentiment: 0.4 },
        { milliseconds: 90000, participantPurpose: 'External', decoratedText: "Yes, address is 27 Green Fill Lane.", sentiment: 0.1 },
        { milliseconds: 120000, participantPurpose: 'Internal', decoratedText: "Great, how can I assist today?", sentiment: 0.9 }
      ];

      renderTranscript(el, transcript, JSON.stringify(transcript, null, 2), { conversationId, conversationStart: '2025-09-23T12:02:00Z', conversationEnd: '2025-09-23T12:09:00Z' });
    }

    function renderTranscript(container, parsed, rawText, conversation){
      const escapeHtml = (s) => (s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
      const mmss = (ms)=>{ const t=Math.max(0,Math.floor((+ms||0)/1000)); const m=Math.floor(t/60), s=t%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); };
      const rows = (parsed || []).map(u => ({
        ms: Number(u.milliseconds)||0,
        rel: mmss(u.milliseconds),
        purpose: (u.participantPurpose||'').toLowerCase()==='internal'?'Internal':'External',
        who: (u.participantPurpose||'').toLowerCase()==='internal'?'Agent':'Customer',
        text: (u.decoratedText||'').toString(),
        sentiment: (u.sentiment!==undefined&&u.sentiment!==null)?u.sentiment:null
      }));
      if(!rows.length){ container.innerHTML=`<pre>${escapeHtml(rawText||'')}</pre>`; return;}
      const startMs=Math.min(...rows.map(r=>r.ms)), endMs=Math.max(...rows.map(r=>r.ms)), duration=mmss(endMs-startMs);
      container.innerHTML=`
        <div class="transcript-summary">
          <div class="t-summary-grid">
            <div class="t-kv"><span class="k">Interaction Type:</span><span>Call</span></div>
            <div class="t-kv"><span class="k">Interaction ID:</span><span class="mono">${conversation.conversationId}</span></div>
            <div class="t-kv"><span class="k">Transcript Start Time:</span><span>${new Date(conversation.conversationStart).toLocaleString()}</span></div>
            <div class="t-kv"><span class="k">Transcript End Time:</span><span>${new Date(conversation.conversationEnd).toLocaleString()}</span></div>
            <div class="t-kv"><span class="k">Transcript Duration:</span><span>${duration}</span></div>
            <div class="t-kv"><span class="k">Direction:</span><span>Inbound</span></div>
            <div class="t-kv"><span class="k">Internal Participant(s):</span><span><span class="pill">Gerard McGlynn</span></span></div>
            <div class="t-kv"><span class="k">External Participant(s):</span><span><span class="pill">Mobile Number, United Kingdom</span></span></div>
          </div>
          <div class="t-section"><h4>Interaction Summary</h4>
            <div class="muted">Summary or insights from the transcript appear here.</div>
          </div>
        </div>
        <table class="transcript-table">
          <thead><tr><th>Time (MM:SS)</th><th>Participant Type</th><th>Participant</th><th>Text</th><th>Sentiment</th></tr></thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td class="mono">${r.rel}</td>
                <td>${r.purpose}</td>
                <td>${r.who}</td>
                <td>${escapeHtml(r.text)}</td>
                <td class="${r.sentiment>0?'sentiment-positive':(r.sentiment<0?'sentiment-negative':'sentiment-neutral')}">
                  ${r.sentiment===null?'-':r.sentiment.toFixed(2)}
                </td>
              </tr>`).join('')}
          </tbody>
        </table>`;
    }
  </script>
</body>
</html>
