<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Conversation Explorer</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 20px; padding: 20px; max-width: 1200px; background: #f8fafc; }
    #logo-container { text-align: center; margin-bottom: 20px; }
    #logo { width: 300px; }
    label { margin-top: 10px; display: block; font-weight: bold; color: #374151; }
    select, input, button { margin-top: 5px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; }
    select, input { width: 100%; max-width: 320px; background: white; }
    button { background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: 600; transition: background 0.2s; }
    button:hover { background: #2563eb; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    #statusMessage { margin-top: 20px; color: #059669; white-space: pre-wrap; font-weight: 500; }
    #errorMessage { margin-top: 10px; color: #dc2626; white-space: pre-wrap; font-weight: 500; }
    .row { display:flex; gap: 20px; flex-wrap:wrap; align-items:flex-end; margin-bottom: 16px; }
    .card { background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px; margin-top: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .muted { color: #6b7280; }
    .loading { opacity: 0.6; pointer-events: none; }
    details { background:#f9fafb; border:1px solid #e5e7eb; border-radius: 8px; padding:12px; margin:10px 0; }
    details>summary { cursor:pointer; font-weight:600; padding: 8px 0; }
    pre { background: #1f2937; color: #f3f4f6; padding: 16px; border-radius: 6px; overflow-x: auto; font-size: 12px; margin: 8px 0; }
    .user-info { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 12px; margin: 12px 0; }
    .stats { display: flex; gap: 16px; margin: 16px 0; }
    .stat-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; flex: 1; text-align: center; }
    .stat-number { font-size: 24px; font-weight: bold; color: #3b82f6; }
    .stat-label { color: #6b7280; font-size: 14px; }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Conversation Explorer</h1>

  <div id="authStatus" class="card" style="display: none;">
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 18px; color: #d97706; margin-bottom: 10px;">üîê Authenticating...</div>
      <div style="color: #6b7280;">Please wait while we connect to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <div class="card">
      <h2 style="margin-top: 0; color: #1f2937;">Select Agent & Date Range</h2>
      
      <div class="row">
        <div>
          <label for="agentSelect">Select Agent</label>
          <select id="agentSelect">
            <option>Loading users...</option>
          </select>
          <input id="agentFilter" type="text" placeholder="Filter users by name or email" style="margin-top: 8px;" />
          <div class="user-info" id="selectedAgentInfo" style="display: none;">
            <strong>Selected Agent:</strong> <span id="selectedAgentName">None</span>
          </div>
        </div>
        <div>
          <label for="fromDate">Date Range</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input id="fromDate" type="date" />
            <span style="color: #6b7280;">to</span>
            <input id="toDate" type="date" />
          </div>
          <div style="margin-top: 16px;">
            <button id="fetchBtn" style="padding: 12px 24px; font-size: 16px;">
              Fetch Conversations
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="statusMessage"></div>
    <div id="errorMessage"></div>

    <div id="resultsSection" style="display: none;">
      <div class="card">
        <h2 style="margin-top: 0; color: #1f2937;">Conversation Results</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalConversations">0</div>
            <div class="stat-label">Total Conversations</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="dateRange">-</div>
            <div class="stat-label">Date Range</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="selectedAgent">-</div>
            <div class="stat-label">Selected Agent</div>
          </div>
        </div>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const CONFIG = {
      clientId: 'd4529142-7340-4cd8-a9f9-f3a4d25670df',
      redirectUri: 'https://gmcglynn88.github.io/ConversationExplorer/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== App State =====
    const state = {
      token: null,
      conversations: [],
      users: [],
      selectedAgent: null
    };

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const fmt = (d) => new Date(d).toLocaleString();

    function setStatus(msg, isError = false) {
      console.log(isError ? 'ERROR:' : 'STATUS:', msg);
      $('statusMessage').textContent = isError ? '' : (msg || '');
      $('errorMessage').textContent = isError ? (msg || '') : '';
    }

    function showMainContent() {
      $('authStatus').style.display = 'none';
      $('mainContent').style.display = 'block';
    }

    function showAuthStatus() {
      $('authStatus').style.display = 'block';
      $('mainContent').style.display = 'none';
    }

    function setLoading(loading) {
      if (loading) {
        $('mainContent').classList.add('loading');
      } else {
        $('mainContent').classList.remove('loading');
      }
    }

    // ===== OAuth handling =====
    function parseTokenFromHash() {
      const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      const token = hashParams.get('access_token');
      const error = hashParams.get('error');
      const errorDescription = hashParams.get('error_description');
      return { token, error, errorDescription };
    }

    function buildAuthUrl() {
      return `${CONFIG.loginHost}/oauth/authorize` +
             `?client_id=${encodeURIComponent(CONFIG.clientId)}` +
             `&response_type=token` +
             `&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }

    function initAuth() {
      console.log('Initializing authentication...');
      showAuthStatus();

      const { token, error, errorDescription } = parseTokenFromHash();

      if (error) {
        const errTxt = `Authentication Error: ${error}${errorDescription ? ` - ${decodeURIComponent(errorDescription)}` : ''}`;
        setStatus(errTxt, true);
        console.error('OAuth error:', errTxt);
        
        // Redirect to auth after a brief delay
        setTimeout(() => {
          sessionStorage.setItem('authAttempted', '1');
          window.location.assign(buildAuthUrl());
        }, 2000);
        return;
      }

      if (token) {
        console.log('Token found, authentication successful');
        state.token = token;
        history.replaceState(null, '', location.pathname);
        
        // Show main content and load users
        showMainContent();
        fetchAllUsers();
        return;
      }

      // No token and no error - initiate OAuth flow
      console.log('No token found, initiating OAuth flow...');
      const alreadyTried = sessionStorage.getItem('authAttempted') === '1';
      
      if (alreadyTried) {
        setStatus('Authentication issue detected. Please check your OAuth client configuration.', true);
        return;
      }

      sessionStorage.setItem('authAttempted', '1');
      window.location.assign(buildAuthUrl());
    }

    // ===== API helper =====
    async function api(path) {
      if (!state.token) throw new Error('Not authenticated');
      
      console.log(`API call: ${path}`);
      const res = await fetch(`${CONFIG.apiHost}${path}`, {
        headers: { 'Authorization': `Bearer ${state.token}` }
      });
      
      if (res.status === 401 || res.status === 403) {
        throw new Error(`Authentication error (${res.status}). Please refresh the page.`);
      }
      
      if (!res.ok) {
        const txt = await res.text().catch(() => '');
        throw new Error(`API Error: ${res.status} ${res.statusText}`);
      }
      
      return res.json();
    }

    // ===== Users =====
    async function fetchAllUsers() {
      try {
        setStatus('Loading users...');
        setLoading(true);
        
        let allUsers = [];
        let pageNumber = 1;
        const pageSize = 100;

        while (true) {
          console.log(`Fetching users page ${pageNumber}...`);
          const data = await api(`/api/v2/users?pageSize=${pageSize}&pageNumber=${pageNumber}`);
          const batch = data?.entities || [];
          allUsers = allUsers.concat(batch);
          
          if (!data?.nextUri || batch.length < pageSize) break;
          pageNumber++;
        }

        // Sort users by name and store
        state.users = allUsers
          .map(u => ({ id: u.id, name: u.name, email: u.email || '' }))
          .sort((a, b) => a.name.localeCompare(b.name));

        console.log(`Loaded ${state.users.length} users`);
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
        setLoading(false);
        
      } catch (e) {
        setStatus(`Failed to load users: ${e.message}`, true);
        setLoading(false);
        $('agentSelect').innerHTML = '<option>Failed to load users</option>';
      }
    }

    function populateUserSelect(users) {
      const select = $('agentSelect');
      select.innerHTML = '<option value="">Select an agent...</option>' + 
        users.map(u =>
          `<option value="${u.id}">${u.name} ${u.email ? `(${u.email})` : ''}</option>`
        ).join('');

      select.onchange = () => {
        const selectedUser = users.find(u => u.id === select.value);
        state.selectedAgent = selectedUser || null;
        
        if (selectedUser) {
          $('selectedAgentName').textContent = `${selectedUser.name} ${selectedUser.email ? `(${selectedUser.email})` : ''}`;
          $('selectedAgentInfo').style.display = 'block';
        } else {
          $('selectedAgentInfo').style.display = 'none';
        }
      };
    }

    // Filter users by name or email
    $('agentFilter').addEventListener('input', function () {
      const query = this.value.trim().toLowerCase();
      const filteredUsers = query
        ? state.users.filter(u =>
          (u.name || '').toLowerCase().includes(query) ||
          (u.email || '').toLowerCase().includes(query)
        )
        : state.users;
      populateUserSelect(filteredUsers);
    });

    // ===== Conversations =====
    async function fetchConversations() {
      try {
        if (!state.selectedAgent) {
          setStatus('Please select an agent first', true);
          return;
        }

        const fromDate = $('fromDate').value;
        const toDate = $('toDate').value || fromDate;
        if (!fromDate) {
          setStatus('Please select a start date', true);
          return;
        }

        setStatus('Fetching conversations...');
        setLoading(true);
        $('resultsSection').style.display = 'none';

        const interval = `${fromDate}T00:00:00/${toDate}T23:59:59`;
        const requestBody = {
          interval,
          order: 'asc',
          orderBy: 'conversationStart',
          segmentFilters: [{
            type: 'and',
            predicates: [{
              type: 'dimension',
              dimension: 'userId',
              operator: 'matches',
              value: state.selectedAgent.id
            }]
          }]
        };

        console.log('Fetching conversations with request:', requestBody);
        const response = await fetch(`${CONFIG.apiHost}/api/v2/analytics/conversations/details/query`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        if (!response.ok) {
          const errorText = await response.text().catch(() => '');
          throw new Error(`Failed to fetch conversations: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        state.conversations = data.conversations || [];
        
        console.log(`Found ${state.conversations.length} conversations`);
        renderResults(state.conversations);
        setStatus(`Found ${state.conversations.length} conversations for the selected period`);
        setLoading(false);
        
      } catch (error) {
        setStatus(`Error fetching conversations: ${error.message}`, true);
        setLoading(false);
      }
    }

    function renderResults(conversations) {
      const resultsContainer = $('results');
      
      // Update stats
      $('totalConversations').textContent = conversations.length;
      $('dateRange').textContent = `${$('fromDate').value} to ${$('toDate').value}`;
      $('selectedAgent').textContent = state.selectedAgent.name;
      
      if (conversations.length === 0) {
        resultsContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #6b7280;">
            <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
            <h3>No Conversations Found</h3>
            <p>No conversations found for ${state.selectedAgent.name} during the selected date range.</p>
          </div>
        `;
      } else {
        resultsContainer.innerHTML = conversations.map(conv => `
          <details>
            <summary>
              <strong>${conv.conversationId}</strong> - ${fmt(conv.conversationStart)}
              <span style="color: #6b7280; font-size: 0.9em; margin-left: 8px;">
                (${conv.participants ? conv.participants.length : 0} participants)
              </span>
            </summary>
            <pre>${JSON.stringify(conv, null, 2)}</pre>
          </details>
        `).join('');
      }
      
      $('resultsSection').style.display = 'block';
    }

    // ===== Event Listeners =====
    $('fetchBtn').addEventListener('click', fetchConversations);

    // ===== Initialize App =====
    (function init() {
      console.log('Initializing Conversation Explorer...');
      
      // Set default dates (last 7 days)
      const today = new Date();
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(today.getDate() - 7);
      $('fromDate').value = oneWeekAgo.toISOString().slice(0, 10);
      $('toDate').value = today.toISOString().slice(0, 10);
      
      // Start authentication flow
      initAuth();
    })();
  </script>
</body>
</html>
