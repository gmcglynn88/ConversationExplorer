<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genesys Conversation Explorer</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      max-width: 1200px;
    }
    #logo-container { text-align: center; margin-bottom: 20px; }
    #logo { width: 300px; }
    label { margin-top: 10px; display: block; font-weight: bold; }
    select, input, button { margin-top: 5px; padding: 8px; width: 100%; max-width: 300px; }
    #statusMessage { margin-top: 20px; color: green; }
    #errorMessage { margin-top: 10px; color: #c1272d; }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 12px; }
    .muted { color: #6b7280; }
    .pill { 
      display:inline-block; 
      padding:4px 12px; 
      background: #10b981; 
      color: white;
      border-radius:999px; 
      font-size:12px; 
      font-weight: bold;
    }
    .pill.error { background: #ef4444; }
    .pill.warning { background: #f59e0b; }
    details { background:#f9fafb; border:1px solid #e5e7eb; border-radius: 8px; padding:12px; margin:10px 0; }
    details>summary { cursor:pointer; font-weight:600; }
    pre { 
      background: #1f2937; 
      color: #f3f4f6; 
      padding: 12px; 
      border-radius: 6px; 
      overflow-x: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Conversation Explorer</h1>

  <div class="row">
    <div>
      <label>Authentication Status</label>
      <span id="authInfo" class="pill warning">Checking...</span>
    </div>
    <div>
      <label>Redirect URI</label>
      <input type="text" id="redirectUriDisplay" readonly style="background: #f3f4f6; border: 1px solid #d1d5db; padding: 8px; border-radius: 4px; width: 100%; max-width: 400px; font-size: 12px;">
    </div>
  </div>

  <div class="row">
    <div>
      <label for="agentSelect">Select Agent</label>
      <select id="agentSelect" disabled><option>Authentication required...</option></select>
      <input id="agentFilter" type="text" placeholder="Filter users by name or email" style="margin-top: 8px;" disabled />
      <div style="margin-top: 8px; font-size: 14px; color: #6b7280;">
        Selected: <span id="selectedAgentName">None</span>
      </div>
    </div>
    <div>
      <label for="fromDate">Date Range</label>
      <div style="display: flex; gap: 8px; align-items: center;">
        <input id="fromDate" type="date" disabled />
        <span>to</span>
        <input id="toDate" type="date" disabled />
      </div>
      <div style="margin-top:12px;">
        <button id="fetchBtn" disabled style="background: #9ca3af; color: white; border: none; border-radius: 6px; padding: 10px 16px; cursor: not-allowed;">
          Fetch Conversations (Authentication Required)
        </button>
      </div>
    </div>
  </div>

  <div id="statusMessage"></div>
  <div id="errorMessage"></div>

  <div class="card" style="margin-top:24px;">
    <h2 style="margin-top: 0;">Conversation Results</h2>
    <div id="results"></div>
  </div>

  <script>
    const state = {
      token: null,
      regionHost: 'https://api.mypurecloud.ie',
      conversations: [],
      users: [],
      selectedAgent: null
    };

    // ========== CONFIGURATION ==========
    const CONFIG = {
      clientId: 'bbc89753-462b-493d-ab94-4778af9e7d4d',
      redirectUri: 'https://gmcglynn88.github.io/ConversationExplorer/',
      regionHost: 'https://api.mypurecloud.ie'
    };
    // ========== END CONFIGURATION ==========

    const $ = (id) => document.getElementById(id);
    const fmt = (d) => new Date(d).toLocaleString();

    function setStatus(msg, isError = false) {
      console.log(`Status: ${msg}`, isError ? 'ERROR' : 'INFO');
      $('statusMessage').textContent = isError ? '' : msg || '';
      $('errorMessage').textContent = isError ? (msg || '') : '';
    }

    function enableUI() {
      $('agentSelect').disabled = false;
      $('agentFilter').disabled = false;
      $('fromDate').disabled = false;
      $('toDate').disabled = false;
      $('fetchBtn').disabled = false;
      $('fetchBtn').style.backgroundColor = '#3b82f6';
      $('fetchBtn').style.cursor = 'pointer';
      $('fetchBtn').textContent = 'Fetch Conversations';
    }

    function disableUI() {
      $('agentSelect').disabled = true;
      $('agentFilter').disabled = true;
      $('fromDate').disabled = true;
      $('toDate').disabled = true;
      $('fetchBtn').disabled = true;
      $('fetchBtn').style.backgroundColor = '#9ca3af';
      $('fetchBtn').style.cursor = 'not-allowed';
    }

    function initAuth() {
      console.log('üîê === AUTHENTICATION DEBUG ===');
      console.log('üìç Current URL:', window.location.href);
      console.log('üéØ Expected Redirect URI:', CONFIG.redirectUri);
      console.log('üîë Client ID:', CONFIG.clientId);

      // Display redirect URI for verification
      $('redirectUriDisplay').value = CONFIG.redirectUri;

      // Check if we're on the correct page for the redirect URI
      const currentUrl = window.location.origin + window.location.pathname;
      if (currentUrl !== CONFIG.redirectUri) {
        console.warn('‚ùå URL MISMATCH: Current URL does not match configured Redirect URI');
        console.warn('   Current:', currentUrl);
        console.warn('   Expected:', CONFIG.redirectUri);
        
        // If we're not on the correct page, redirect to it
        console.log('üîÑ Redirecting to correct URL...');
        window.location.href = CONFIG.redirectUri;
        return false;
      }

      console.log('‚úÖ URL matches configured Redirect URI');

      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token = params.get('access_token');
      const error = params.get('error');
      const errorDescription = params.get('error_description');
      
      console.log('üîç URL Hash Parameters:');
      console.log('   - Token present:', token ? 'YES' : 'NO');
      console.log('   - OAuth Error:', error || 'None');
      console.log('   - Error Description:', errorDescription || 'None');

      // Check for OAuth errors first
      if (error) {
        const errorMsg = `OAuth Error: ${error}${errorDescription ? ` - ${errorDescription}` : ''}`;
        console.error('‚ùå OAuth authentication failed:', errorMsg);
        setStatus(errorMsg, true);
        $('authInfo').textContent = 'Authentication Failed';
        $('authInfo').className = 'pill error';
        disableUI();
        return false;
      }

      if (token) {
        console.log('‚úÖ Token found, authentication successful');
        console.log('üîë Token (first 50 chars):', token.substring(0, 50) + '...');
        state.token = token;
        $('authInfo').textContent = 'Authenticated ‚úì';
        $('authInfo').className = 'pill';
        
        // Clean URL - remove hash fragment
        console.log('üßπ Cleaning URL - removing hash fragment');
        history.replaceState(null, '', location.pathname + location.search);
        
        enableUI();
        return true;
      } else {
        console.log('‚ùå No token found, starting OAuth flow...');
        $('authInfo').textContent = 'Redirecting to login...';
        $('authInfo').className = 'pill warning';
        
        // Start OAuth flow with hardcoded redirect URI
        const authUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${CONFIG.clientId}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
        
        console.log('üîÑ Building OAuth URL:', authUrl);
        console.log('üí° Make sure this exact Redirect URI is registered in your Genesys Cloud OAuth client:');
        console.log('   ', CONFIG.redirectUri);
        
        setTimeout(() => {
          console.log('üöÄ Redirecting to OAuth provider...');
          window.location.href = authUrl;
        }, 1000);
        
        return false;
      }
    }

    async function api(path) {
      if (!state.token) throw new Error('Not authenticated');
      console.log(`üì° API Call: ${path}`);
      
      const res = await fetch(`${state.regionHost}${path}`, {
        headers: { 'Authorization': `Bearer ${state.token}` }
      });
      
      console.log(`üì° API Response: ${res.status} ${res.statusText}`);
      
      if (!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function fetchAllUsers() {
      try {
        setStatus('Loading users‚Ä¶');
        console.log('üë• Starting to fetch users...');
        
        let allUsers = [];
        let pageNumber = 1;
        const pageSize = 100;

        while (true) {
          console.log(`üìÑ Fetching users page ${pageNumber}...`);
          const data = await api(`/api/v2/users?pageSize=${pageSize}&pageNumber=${pageNumber}`);
          const batch = data?.entities || [];
          console.log(`üì• Received ${batch.length} users in this batch`);
          
          allUsers = allUsers.concat(batch);
          
          if (!data?.nextUri || batch.length < pageSize) break;
          pageNumber++;
        }

        state.users = allUsers.map(u => ({ 
          id: u.id, 
          name: u.name, 
          email: u.email || '' 
        }));
        
        console.log(`‚úÖ Total users loaded: ${state.users.length}`);
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
        
      } catch (e) {
        console.error('‚ùå Error fetching users:', e);
        setStatus(e.message, true);
        $('agentSelect').innerHTML = '<option>Failed to load users</option>';
      }
    }

    function populateUserSelect(users) {
      const select = $('agentSelect');
      select.innerHTML = users.map(u => 
        `<option value="${u.id}">${u.name} ${u.email ? `(${u.email})` : ''}</option>`
      ).join('');
      
      select.onchange = () => {
        const selectedUser = users.find(u => u.id === select.value);
        state.selectedAgent = selectedUser;
        $('selectedAgentName').textContent = selectedUser ? `${selectedUser.name}` : 'None';
        console.log(`üë§ Selected agent: ${selectedUser?.name} (${selectedUser?.id})`);
      };
      
      if (users.length > 0) {
        select.value = users[0].id;
        select.onchange();
      }
    }

    $('agentFilter').addEventListener('input', function() {
      const query = this.value.trim().toLowerCase();
      const filteredUsers = query 
        ? state.users.filter(u => 
            u.name.toLowerCase().includes(query) || 
            u.email.toLowerCase().includes(query)
          )
        : state.users;
      populateUserSelect(filteredUsers);
    });

    async function fetchConversations() {
      try {
        setStatus('Fetching conversations...');
        console.log('üí¨ Starting conversation fetch...');
        
        if (!state.selectedAgent) {
          throw new Error('Please select an agent first');
        }

        const fromDate = $('fromDate').value;
        const toDate = $('toDate').value || fromDate;
        
        if (!fromDate) {
          throw new Error('Please select a start date');
        }

        console.log(`üìÖ Fetching conversations for agent ${state.selectedAgent.name} from ${fromDate} to ${toDate}`);

        const interval = `${fromDate}T00:00:00/${toDate}T23:59:59`;

        const requestBody = {
          interval: interval,
          order: 'asc',
          orderBy: 'conversationStart',
          segmentFilters: [{
            type: 'and',
            predicates: [{
              type: 'dimension',
              dimension: 'userId',
              operator: 'matches',
              value: state.selectedAgent.id
            }]
          }]
        };

        console.log('üì§ Sending analytics query:', JSON.stringify(requestBody, null, 2));

        const response = await fetch(`${state.regionHost}/api/v2/analytics/conversations/details/query`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        console.log(`üì• Analytics API response: ${response.status} ${response.statusText}`);

        if (!response.ok) {
          const errorText = await response.text();
          console.error('‚ùå Analytics API error response:', errorText);
          throw new Error(`Failed to fetch conversations: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        state.conversations = data.conversations || [];
        console.log(`‚úÖ Received ${state.conversations.length} conversations`);
        renderResults(state.conversations);
        setStatus(`Found ${state.conversations.length} conversations`);

      } catch (error) {
        console.error('‚ùå Error fetching conversations:', error);
        setStatus(error.message, true);
      }
    }

    function renderResults(conversations) {
      const resultsContainer = $('results');
      
      if (conversations.length === 0) {
        resultsContainer.innerHTML = '<p class="muted">No conversations found for the selected criteria.</p>';
        return;
      }

      resultsContainer.innerHTML = conversations.map(conv => `
        <details>
          <summary>
            <strong>${conv.conversationId}</strong> - 
            ${fmt(conv.conversationStart)}
            <span style="color: #6b7280; font-size: 0.9em; margin-left: 8px;">
              (${conv.participants ? conv.participants.length : 0} participants)
            </span>
          </summary>
          <pre>${JSON.stringify(conv, null, 2)}</pre>
        </details>
      `).join('');
    }

    // Initialize the application
    $('fetchBtn').addEventListener('click', fetchConversations);

    (function init() {
      console.log('üöÄ === APPLICATION INITIALIZATION ===');
      
      // Set default dates (today and 7 days ago)
      const today = new Date();
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(today.getDate() - 7);
      
      $('fromDate').value = oneWeekAgo.toISOString().slice(0, 10);
      $('toDate').value = today.toISOString().slice(0, 10);

      // Start authentication
      const isAuthenticated = initAuth();
      if (isAuthenticated) {
        console.log('‚úÖ Authentication successful, loading users...');
        fetchAllUsers();
      } else {
        console.log('üîÑ Authentication required, redirecting to OAuth...');
      }
    })();
  </script>
</body>
</html>
