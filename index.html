<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Genesys Conversation Explorer</title>
  <style>
    :root {
      --primary-color: #63AB8F;
      --secondary-color: #4A8C7D;
      --border-color: #DEE2E6;
      --light-bg: #F8F9FA;
      --card-bg: #FFFFFF;
      --text-color: #2C3E50;
      --text-light: #6C757D;
      --available-color: #63AB8F; /* use same green for outlines */
      --nearly-color: #ffe0b2;
      --full-color: #ffcdd2;
    }

    body { 
      font-family: 'Segoe UI', Arial, sans-serif; 
      margin: 20px; 
      padding: 20px; 
      max-width: 1200px; 
      background: var(--light-bg);
      color: var(--text-color);
    }
    #logo-container { text-align: center; margin-bottom: 20px; }
    #logo { width: 300px; }
    label { margin-top: 10px; display: block; font-weight: bold; color: var(--text-color); }
    select, input, button { margin-top: 5px; padding: 10px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 14px; }
    select, input { width: 100%; max-width: 320px; background: var(--card-bg); }
    button { 
      background: var(--primary-color); 
      color: white; 
      border: none; 
      cursor: pointer; 
      font-weight: 600; 
      transition: background 0.2s; 
    }
    button:hover { background: var(--secondary-color); }
    button:disabled { background: var(--text-light); cursor: not-allowed; }
    #statusMessage { margin-top: 20px; color: var(--primary-color); white-space: pre-wrap; font-weight: 500; }
    #errorMessage { margin-top: 10px; color: #dc2626; white-space: pre-wrap; font-weight: 500; }
    .row { display:flex; gap: 20px; flex-wrap:wrap; align-items:flex-end; margin-bottom: 16px; }
    .card { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 12px; 
      padding: 24px; 
      margin-top: 16px; 
      box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    }
    .muted { color: var(--text-light); }
    .loading { opacity: 0.6; pointer-events: none; }
    details { 
      background: var(--light-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      padding: 16px; 
      margin: 12px 0; 
    }
    details>summary { 
      cursor: pointer; 
      font-weight: 600; 
      padding: 8px 0; 
      font-size: 16px; 
      color: var(--text-color);
    }
    pre { 
      background: #1f2937; 
      color: #f3f4f6; 
      padding: 16px; 
      border-radius: 6px; 
      overflow-x: auto; 
      font-size: 12px; 
      margin: 8px 0; 
    }

    /* Outline-only styles (no green fill) */
    .user-info { 
      background: transparent; 
      border: 2px solid var(--available-color); 
      border-radius: 8px; 
      padding: 12px; 
      margin: 12px 0; 
    }
    .conversation-header { 
      background: transparent; 
      border: 2px solid var(--available-color); 
      border-radius: 8px; 
      padding: 16px; 
      margin: 12px 0; 
    }

    .stats { display: flex; gap: 16px; margin: 16px 0; }
    .stat-card { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 8px; 
      padding: 16px; 
      flex: 1; 
      text-align: center; 
    }
    .stat-number { font-size: 24px; font-weight: bold; color: var(--primary-color); }
    .stat-label { color: var(--text-light); font-size: 14px; }

    .journey-timeline { 
      margin: 20px 0; 
      padding-left: 20px; 
      border-left: 3px solid var(--primary-color); 
    }
    .journey-step { margin-bottom: 20px; position: relative; }
    .journey-step:before { 
      content: ''; 
      position: absolute; 
      left: -26px; 
      top: 0; 
      width: 16px; 
      height: 16px; 
      border-radius: 50%; 
      background: var(--primary-color); 
    }
    .step-header { font-weight: bold; color: var(--secondary-color); margin-bottom: 8px; }
    .step-details { 
      background: var(--card-bg); 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      padding: 12px; 
    }
    .info-grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 12px; 
      margin: 12px 0; 
    }
    .info-item { 
      display: flex; 
      justify-content: space-between; 
      padding: 8px 0; 
      border-bottom: 1px solid var(--border-color); 
    }
    .info-label { 
      font-weight: 600; 
      color: var(--text-color); 
      min-width: 140px; 
      white-space: nowrap;
    }
    .info-value { 
      color: var(--text-color); 
      text-align: right; 
      flex: 1; 
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .participant-badge { 
      display: inline-block; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-size: 12px; 
      font-weight: 600; 
      margin: 2px; 
      border: 1px solid transparent;
    }
    /* If you also want the customer badge to be outline-only, swap the backgrounds: */
    .badge-customer { 
      /* outline-only version: */
      background: transparent; 
      border-color: var(--available-color);
      color: var(--secondary-color);
      /* filled version (old):
      background: #c8e6c9; color: var(--secondary-color);
      */
    }
    .badge-agent { background: #dbeafe; color: #1e40af; }
    .badge-system { background: var(--nearly-color); color: #92400e; }
    .badge-queue { background: var(--full-color); color: #7c3aed; }
    .badge-ivr { background: #fce7f3; color: #be185d; }

    .transfer-count { 
      background: #fecaca; 
      color: #dc2626; 
      padding: 4px 8px; 
      border-radius: 4px; 
      font-weight: bold; 
    }
    .transfer-info { 
      background: var(--nearly-color); 
      border: 1px solid var(--border-color); 
      border-radius: 4px; 
      padding: 8px; 
      margin: 8px 0; 
    }
    .progress-bar { 
      width: 100%; 
      height: 8px; 
      background: var(--border-color); 
      border-radius: 4px; 
      margin: 10px 0; 
      overflow: hidden; 
    }
    .progress-fill { 
      height: 100%; 
      background: var(--primary-color); 
      transition: width 0.3s ease; 
    }
    .chunk-info { 
      background: var(--nearly-color); 
      border: 1px solid var(--border-color); 
      border-radius: 6px; 
      padding: 12px; 
      margin: 12px 0; 
    }
    .duration-badge { 
      background: #eefbf4; 
      color: var(--secondary-color); 
      padding: 2px 6px; 
      border: 1px solid var(--available-color);
      border-radius: 4px; 
      font-size: 11px; 
      font-weight: 600; 
    }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Conversation Explorer</h1>

  <div id="authStatus" class="card" style="display: none;">
    <div style="text-align: center; padding: 20px;">
      <div style="font-size: 18px; color: var(--secondary-color); margin-bottom: 10px;">üîê Authenticating...</div>
      <div style="color: var(--text-light);">Please wait while we connect to Genesys Cloud</div>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <div class="card">
      <h2 style="margin-top: 0; color: var(--text-color);">Select Agent & Date Range</h2>
      
      <div class="row">
        <div>
          <label for="agentSelect">Select Agent</label>
          <select id="agentSelect">
            <option>Loading users...</option>
          </select>
          <input id="agentFilter" type="text" placeholder="Filter users by name or email" style="margin-top: 8px;" />
          <div class="user-info" id="selectedAgentInfo" style="display: none;">
            <strong>Selected Agent:</strong> <span id="selectedAgentName">None</span>
          </div>
        </div>
        <div>
          <label for="fromDate">Date Range</label>
          <div style="display: flex; gap: 8px; align-items: center;">
            <input id="fromDate" type="date" />
            <span style="color: var(--text-light);">to</span>
            <input id="toDate" type="date" />
          </div>
          <div style="margin-top: 8px;">
            <label>
              <input type="checkbox" id="autoChunk" checked />
              Auto-split large date ranges (recommended)
            </label>
          </div>
          <div style="margin-top: 16px;">
            <button id="fetchBtn" style="padding: 12px 24px; font-size: 16px;">
              Fetch Conversations
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="statusMessage"></div>
    <div id="errorMessage"></div>

    <div id="progressSection" style="display: none;">
      <div class="card">
        <h3 style="margin-top: 0; color: var(--text-color);">Fetching Conversations</h3>
        <div class="chunk-info" id="chunkInfo">
          Processing date range in smaller chunks...
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--text-light);">
          <span id="progressText">0%</span>
          <span id="chunkText">Chunk 0/0</span>
        </div>
      </div>
    </div>

    <div id="resultsSection" style="display: none;">
      <div class="card">
        <h2 style="margin-top: 0; color: var(--text-color);">Conversation Results</h2>
        <div class="stats">
          <div class="stat-card">
            <div class="stat-number" id="totalConversations">0</div>
            <div class="stat-label">Total Conversations</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="dateRange">-</div>
            <div class="stat-label">Date Range</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="selectedAgent">-</div>
            <div class="stat-label">Selected Agent</div>
          </div>
        </div>
        <div id="results"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== Configuration =====
    const CONFIG = {
      clientId: 'd4529142-7340-4cd8-a9f9-f3a4d25670df',
      redirectUri: 'https://gmcglynn88.github.io/ConversationExplorer/',
      loginHost: 'https://login.mypurecloud.ie',
      apiHost: 'https://api.mypurecloud.ie'
    };

    // ===== App State =====
    const state = {
      token: null,
      conversations: [],
      users: [],
      selectedAgent: null
    };

    // ===== Helpers =====
    const $ = (id) => document.getElementById(id);
    const fmt = (d) => {
      if (!d || d === 'Invalid Date') return 'N/A';
      try { return new Date(d).toLocaleString(); } catch { return 'N/A'; }
    };
    
    const formatSeconds = (ms) => {
      if (!ms || ms === 0) return '0s';
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      if (hours > 0) return `${hours}h ${minutes % 60}m ${seconds % 60}s`;
      if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
      return `${seconds}s`;
    };

    const formatShortSeconds = (ms) => {
      if (!ms || ms === 0) return '0s';
      const seconds = Math.floor(ms / 1000);
      return `${seconds}s`;
    };

    const calculateDuration = (startTime, endTime) => {
      if (!startTime || !endTime) return 0;
      try { return new Date(endTime) - new Date(startTime); } catch { return 0; }
    };

    function setStatus(msg, isError = false) {
      console.log(isError ? 'ERROR:' : 'STATUS:', msg);
      $('statusMessage').textContent = isError ? '' : (msg || '');
      $('errorMessage').textContent = isError ? (msg || '') : '';
    }
    function showMainContent() { $('authStatus').style.display = 'none'; $('mainContent').style.display = 'block'; }
    function showAuthStatus() { $('authStatus').style.display = 'block'; $('mainContent').style.display = 'none'; }
    function setLoading(loading) { $('mainContent').classList.toggle('loading', !!loading); }
    function updateProgress(percent, currentChunk, totalChunks) {
      $('progressFill').style.width = `${percent}%`;
      $('progressText').textContent = `${Math.round(percent)}%`;
      $('chunkText').textContent = `Chunk ${currentChunk}/${totalChunks}`;
    }
    function showProgress() { $('progressSection').style.display = 'block'; $('resultsSection').style.display = 'none'; }
    function hideProgress() { $('progressSection').style.display = 'none'; }

    // ===== OAuth handling =====
    function parseTokenFromHash() {
      const hashParams = new URLSearchParams(window.location.hash.replace(/^#/, ''));
      return { 
        token: hashParams.get('access_token'),
        error: hashParams.get('error'),
        errorDescription: hashParams.get('error_description')
      };
    }
    function buildAuthUrl() {
      return `${CONFIG.loginHost}/oauth/authorize` +
             `?client_id=${encodeURIComponent(CONFIG.clientId)}` +
             `&response_type=token` +
             `&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}`;
    }
    function initAuth() {
      console.log('Initializing authentication...');
      showAuthStatus();
      const { token, error, errorDescription } = parseTokenFromHash();

      if (error) {
        const errTxt = `Authentication Error: ${error}${errorDescription ? ` - ${decodeURIComponent(errorDescription)}` : ''}`;
        setStatus(errTxt, true);
        setTimeout(() => {
          sessionStorage.setItem('authAttempted', '1');
          window.location.assign(buildAuthUrl());
        }, 2000);
        return;
      }

      if (token) {
        state.token = token;
        history.replaceState(null, '', location.pathname);
        showMainContent();
        fetchAllUsers();
        return;
      }

      const alreadyTried = sessionStorage.getItem('authAttempted') === '1';
      if (alreadyTried) {
        setStatus('Authentication issue detected. Please check your OAuth client configuration.', true);
        return;
      }
      sessionStorage.setItem('authAttempted', '1');
      window.location.assign(buildAuthUrl());
    }

    // ===== API helper =====
    async function api(path) {
      if (!state.token) throw new Error('Not authenticated');
      const res = await fetch(`${CONFIG.apiHost}${path}`, {
        headers: { 'Authorization': `Bearer ${state.token}` }
      });
      if (res.status === 401 || res.status === 403) {
        throw new Error(`Authentication error (${res.status}). Please refresh the page.`);
      }
      if (!res.ok) throw new Error(`API Error: ${res.status} ${res.statusText}`);
      return res.json();
    }

    // ===== Users =====
    async function fetchAllUsers() {
      try {
        setStatus('Loading users...');
        setLoading(true);
        let allUsers = [];
        let pageNumber = 1;
        const pageSize = 100;

        while (true) {
          const data = await api(`/api/v2/users?pageSize=${pageSize}&pageNumber=${pageNumber}`);
          const batch = data?.entities || [];
          allUsers = allUsers.concat(batch);
          if (!data?.nextUri || batch.length < pageSize) break;
          pageNumber++;
        }

        state.users = allUsers
          .map(u => ({ id: u.id, name: u.name, email: u.email || '' }))
          .sort((a, b) => a.name.localeCompare(b.name));

        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} users`);
        setLoading(false);
      } catch (e) {
        setStatus(`Failed to load users: ${e.message}`, true);
        setLoading(false);
        $('agentSelect').innerHTML = '<option>Failed to load users</option>';
      }
    }

    function populateUserSelect(users) {
      const select = $('agentSelect');
      select.innerHTML = '<option value="">Select an agent...</option>' + 
        users.map(u =>
          `<option value="${u.id}">${u.name} ${u.email ? `(${u.email})` : ''}</option>`
        ).join('');

      select.onchange = () => {
        const selectedUser = users.find(u => u.id === select.value);
        state.selectedAgent = selectedUser || null;
        if (selectedUser) {
          $('selectedAgentName').textContent = `${selectedUser.name} ${selectedUser.email ? `(${selectedUser.email})` : ''}`;
          $('selectedAgentInfo').style.display = 'block';
        } else {
          $('selectedAgentInfo').style.display = 'none';
        }
      };
    }

    $('agentFilter').addEventListener('input', function () {
      const query = this.value.trim().toLowerCase();
      const filteredUsers = query
        ? state.users.filter(u =>
          (u.name || '').toLowerCase().includes(query) ||
          (u.email || '').toLowerCase().includes(query)
        )
        : state.users;
      populateUserSelect(filteredUsers);
    });

    // ===== Date Range Chunking =====
    function splitDateRangeIntoChunks(startDate, endDate, daysPerChunk = 7) {
      const chunks = [];
      const start = new Date(startDate);
      const end = new Date(endDate);
      let currentStart = new Date(start);
      while (currentStart <= end) {
        let currentEnd = new Date(currentStart);
        currentEnd.setDate(currentEnd.getDate() + daysPerChunk - 1);
        if (currentEnd > end) currentEnd = new Date(end);
        chunks.push({
          start: currentStart.toISOString().split('T')[0],
          end: currentEnd.toISOString().split('T')[0]
        });
        currentStart.setDate(currentStart.getDate() + daysPerChunk);
      }
      return chunks;
    }

    function calculateOptimalChunkSize(startDate, endDate) {
      const start = new Date(startDate);
      const end = new Date(endDate);
      const totalDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
      if (totalDays <= 7) return 7;
      if (totalDays <= 30) return 7;
      if (totalDays <= 90) return 5;
      if (totalDays <= 180) return 3;
      return 2;
    }

    // ===== Sessions/Segments-aware helpers =====
    function getParticipantTimes(participant) {
      const starts = [];
      const ends = [];
      for (const s of (participant.sessions || [])) {
        if (s.startTime) starts.push(new Date(s.startTime));
        if (s.endTime)   ends.push(new Date(s.endTime));
        for (const seg of (s.segments || [])) {
          if (seg.startTime) starts.push(new Date(seg.startTime));
          if (seg.endTime)   ends.push(new Date(seg.endTime));
        }
      }
      const start = starts.length ? new Date(Math.min(...starts)) : null;
      const end   = ends.length   ? new Date(Math.max(...ends))   : null;
      return { start, end, durationMs: (start && end) ? (end - start) : 0 };
    }

    function getConversationMediaTypes(conversation) {
      const types = new Set();
      for (const p of (conversation.participants || [])) {
        for (const s of (p.sessions || [])) {
          if (s.mediaType) types.add(s.mediaType);
        }
      }
      return [...types].join(', ') || 'Unknown';
    }

    function getANI(conversation) {
      for (const p of (conversation.participants || [])) {
        for (const s of (p.sessions || [])) {
          const isVoice = (s.mediaType || '').toLowerCase() === 'voice';
          const dir = (s.direction || conversation.originatingDirection || '').toLowerCase();
          const isInbound = dir === 'inbound';
          if (isVoice && isInbound) {
            return s.ani || s.addressFrom || s.otherAddress || s.remote || 'Unknown';
          }
        }
      }
      return 'Unknown';
    }

    function getParticipantAlertMs(participant) {
      let total = 0;
      for (const s of (participant.sessions || [])) {
        for (const seg of (s.segments || [])) {
          for (const m of (seg.metrics || [])) {
            if (m.name === 'tAlert' && typeof m.value === 'number') {
              total += m.value;
            }
          }
        }
      }
      return total;
    }

    function analyzeTransfers(conversation) {
      const transfers = [];
      const legs = [];

      for (const p of (conversation.participants || [])) {
        for (const s of (p.sessions || [])) {
          const segStarts = (s.segments || [])
            .map(x => x?.startTime ? new Date(x.startTime).getTime() : NaN)
            .filter(n => !Number.isNaN(n))
            .sort((a,b)=>a-b);
          const when = segStarts.length ? segStarts[0] : (s.startTime ? new Date(s.startTime).getTime() : 0);
          legs.push({
            when,
            purpose: p.purpose,
            userId: p.userId || null,
            queueId: s.queueId || p.queueId || null
          });
        }
      }

      legs.sort((a,b)=>a.when - b.when);

      for (let i = 1; i < legs.length; i++) {
        const prev = legs[i-1];
        const curr = legs[i];
        const queueChanged = prev.queueId && curr.queueId && prev.queueId !== curr.queueId;
        const agentChanged = prev.userId && curr.userId && prev.userId !== curr.userId;

        if (queueChanged || agentChanged || (prev.purpose === 'acd' && curr.userId)) {
          transfers.push({
            step: i, 
            from: prev.userId ? getParticipantName({ userId: prev.userId, purpose: 'user' }) : (prev.queueId ? 'Queue' : prev.purpose || 'Unknown'),
            to:   curr.userId ? getParticipantName({ userId: curr.userId, purpose: 'user' }) : (curr.queueId ? 'Queue' : curr.purpose || 'Unknown'),
            time: new Date(curr.when).toISOString(),
            type: curr.userId ? 'To Agent' : 'To Queue'
          });
        }
      }

      return { transfers, totalTransfers: transfers.length };
    }

    // ===== Conversations =====
    async function fetchConversations() {
      try {
        if (!state.selectedAgent) return setStatus('Please select an agent first', true);

        const fromDate = $('fromDate').value;
        const toDate = $('toDate').value || fromDate;
        if (!fromDate) return setStatus('Please select a start date', true);

        setStatus('Fetching conversations...');
        setLoading(true);
        $('resultsSection').style.display = 'none';

        const autoChunk = $('autoChunk').checked;
        let dateChunks;

        if (autoChunk) {
          const chunkSize = calculateOptimalChunkSize(fromDate, toDate);
          dateChunks = splitDateRangeIntoChunks(fromDate, toDate, chunkSize);
          $('chunkInfo').innerHTML = `
            Large date range detected: <strong>${fromDate} to ${toDate}</strong><br>
            Auto-splitting into <strong>${dateChunks.length} chunks</strong> of ${chunkSize} days each for better performance.
          `;
        } else {
          dateChunks = [{ start: fromDate, end: toDate }];
          $('chunkInfo').innerHTML = `Processing date range: <strong>${fromDate} to ${toDate}</strong>`;
        }

        showProgress();
        state.conversations = [];

        for (let i = 0; i < dateChunks.length; i++) {
          const chunk = dateChunks[i];
          const progress = ((i) / dateChunks.length) * 100;
          updateProgress(progress, i + 1, dateChunks.length);
          setStatus(`Fetching chunk ${i + 1}/${dateChunks.length}: ${chunk.start} to ${chunk.end}`);

          try {
            const chunkConversations = await fetchConversationsForDateRange(chunk.start, chunk.end);
            state.conversations = state.conversations.concat(chunkConversations);
          } catch (error) {
            console.error(`Error in chunk ${i + 1}:`, error);
            setStatus(`Warning: Failed to fetch chunk ${i + 1}, continuing with remaining chunks...`, true);
          }
          if (i < dateChunks.length - 1) await new Promise(r => setTimeout(r, 500));
        }

        updateProgress(100, dateChunks.length, dateChunks.length);
        renderResults(state.conversations);
        setStatus(`Found ${state.conversations.length} conversations for the selected period`);
        setLoading(false);
        hideProgress();
      } catch (error) {
        setStatus(`Error fetching conversations: ${error.message}`, true);
        setLoading(false);
        hideProgress();
      }
    }

    async function fetchConversationsForDateRange(fromDate, toDate) {
      const interval = `${fromDate}T00:00:00/${toDate}T23:59:59`;
      const requestBody = {
        interval,
        order: 'asc',
        orderBy: 'conversationStart',
        segmentFilters: [{
          type: 'and',
          predicates: [{
            type: 'dimension',
            dimension: 'userId',
            operator: 'matches',
            value: state.selectedAgent.id
          }]
        }]
        // If you want stricter interval behaviour, you can add:
        // "startOfDayIntervalMatching": true
      };

      const response = await fetch(`${CONFIG.apiHost}/api/v2/analytics/conversations/details/query`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${state.token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
      });

      if (!response.ok) {
        throw new Error(`Failed to fetch conversations: ${response.status} ${response.statusText}`);
      }

      const data = await response.json();
      return data.conversations || [];
    }

    function renderResults(conversations) {
      const resultsContainer = $('results');
      const fromDate = $('fromDate').value || '-';
      const toDate = $('toDate').value || fromDate;

      $('totalConversations').textContent = conversations.length;
      $('dateRange').textContent = `${fromDate} to ${toDate}`;
      $('selectedAgent').textContent = state.selectedAgent?.name || '-';
      
      if (conversations.length === 0) {
        resultsContainer.innerHTML = `
          <div style="text-align: center; padding: 40px; color: var(--text-light);">
            <div style="font-size: 48px; margin-bottom: 16px;">üì≠</div>
            <h3>No Conversations Found</h3>
            <p>No conversations found for ${state.selectedAgent?.name || 'the selected agent'} during the selected date range.</p>
          </div>
        `;
      } else {
        resultsContainer.innerHTML = conversations.map(conv => `
          <details>
            <summary>
              <strong>${conv.conversationId}</strong> - ${fmt(conv.conversationStart)}
              <span style="color: var(--text-light); font-size: 0.9em; margin-left: 8px;">
                (${conv.participants ? conv.participants.length : 0} participants)
              </span>
            </summary>
            ${renderConversationDetails(conv)}
          </details>
        `).join('');
      }
      $('resultsSection').style.display = 'block';
    }

    function renderConversationDetails(conversation) {
      const mediaType = getConversationMediaTypes(conversation);
      const direction = conversation.originatingDirection || 'Unknown';
      const ani = getANI(conversation);
      const transferInfo = analyzeTransfers(conversation);
      const totalDuration = calculateDuration(conversation.conversationStart, conversation.conversationEnd);
      
      return `
        <div class="conversation-header">
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Media Type(s):</span>
              <span class="info-value">${mediaType}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Direction:</span>
              <span class="info-value">${direction}</span>
            </div>
            <div class="info-item">
              <span class="info-label">ANI (Caller ID):</span>
              <span class="info-value">${ani}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Total Transfers:</span>
              <span class="info-value"><span class="transfer-count">${transferInfo.totalTransfers}</span></span>
            </div>
            <div class="info-item">
              <span class="info-label">Conversation Start:</span>
              <span class="info-value">${fmt(conversation.conversationStart)}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Conversation End:</span>
              <span class="info-value">${fmt(conversation.conversationEnd)}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Total Duration:</span>
              <span class="info-value">${formatSeconds(totalDuration)}</span>
            </div>
          </div>
        </div>
        
        <h3 style="color: var(--text-color);">Customer Journey Timeline</h3>
        <div class="journey-timeline">
          ${renderJourneyTimeline(conversation, transferInfo)}
        </div>
        
        <details>
          <summary>Raw Conversation Data</summary>
          <pre>${JSON.stringify(conversation, null, 2)}</pre>
        </details>
      `;
    }

    function renderJourneyTimeline(conversation, transferInfo) {
      if (!conversation.participants || conversation.participants.length === 0) {
        return '<p>No participant data available</p>';
      }

      const sortedParticipants = [...conversation.participants].sort((a, b) => {
        const ta = getParticipantTimes(a).start?.getTime() ?? Infinity;
        const tb = getParticipantTimes(b).start?.getTime() ?? Infinity;
        return ta - tb;
      });

      return sortedParticipants.map((participant, index) => {
        const purpose = participant.purpose || 'unknown';
        const participantName = getParticipantName(participant);
        const { start, end, durationMs } = getParticipantTimes(participant);
        const duration = formatSeconds(durationMs);
        const alertMs = getParticipantAlertMs(participant);
        const alertTime = alertMs ? formatShortSeconds(alertMs) : 'N/A';

        const transfer = transferInfo.transfers.find(t => t.step === index);
        
        return `
          <div class="journey-step">
            <div class="step-header">
              Step ${index + 1}: ${getParticipantBadge(purpose, participantName)}
              ${transfer ? `<span style="color: #dc2626; margin-left: 8px;">üîÑ TRANSFERRED</span>` : ''}
            </div>
            <div class="step-details">
              ${transfer ? `
                <div class="transfer-info">
                  <strong>Transfer Details:</strong><br>
                  From: ${transfer.from}<br>
                  To: ${transfer.to}<br>
                  Type: ${transfer.type}<br>
                  Time: ${fmt(transfer.time)}
                </div>
              ` : ''}

              <div class="info-grid">
                <div class="info-item">
                  <span class="info-label">Participant Type:</span>
                  <span class="info-value">${getParticipantType(participant)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Start Time:</span>
                  <span class="info-value">${fmt(start)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">End Time:</span>
                  <span class="info-value">${fmt(end)}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Duration:</span>
                  <span class="info-value">${duration}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Alert Time:</span>
                  <span class="info-value">${alertTime}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">Purpose:</span>
                  <span class="info-value">${purpose}</span>
                </div>
                <div class="info-item">
                  <span class="info-label">State:</span>
                  <span class="info-value">${participant.state || 'N/A'}</span>
                </div>
                ${participant.userId ? `
                <div class="info-item">
                  <span class="info-label">User ID:</span>
                  <span class="info-value" style="font-family: monospace; font-size: 11px;">${participant.userId}</span>
                </div>` : ''}
                ${participant.queueId ? `
                <div class="info-item">
                  <span class="info-label">Queue ID:</span>
                  <span class="info-value" style="font-family: monospace; font-size: 11px;">${participant.queueId}</span>
                </div>` : ''}
              </div>

              ${participant.addresses && participant.addresses.length > 0 ? `
                <div style="margin-top: 8px;">
                  <strong>Addresses:</strong> 
                  ${participant.addresses.map(addr => 
                    `<span class="participant-badge badge-system">${addr.raw || addr.display || 'N/A'}</span>`
                  ).join('')}
                </div>
              ` : ''}

              ${participant.sessions && participant.sessions.length > 0 ? `
                <div style="margin-top: 8px;">
                  <strong>Sessions:</strong> ${participant.sessions.length}
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    function getParticipantName(participant) {
      if (participant.purpose === 'customer') return 'Customer';
      if (participant.userId) {
        const user = state.users.find(u => u.id === participant.userId);
        return user ? user.name : `Agent (${participant.userId})`;
      }
      if (participant.purpose === 'acd') return 'ACD Queue';
      if (participant.purpose === 'ivr') return 'IVR System';
      if (participant.purpose === 'external') return 'External System';
      return participant.purpose || 'Unknown';
    }

    function getParticipantType(participant) {
      if (participant.purpose === 'customer') return 'Customer';
      if (participant.userId) return 'Agent';
      if (participant.purpose === 'acd') return 'Queue';
      if (participant.purpose === 'ivr') return 'IVR System';
      if (participant.purpose === 'external') return 'External';
      return participant.purpose || 'Unknown';
    }

    function getParticipantBadge(purpose, name) {
      const badgeClass = {
        'customer': 'badge-customer',
        'acd': 'badge-queue',
        'user': 'badge-agent',
        'ivr': 'badge-ivr',
        'external': 'badge-system',
        'queue': 'badge-queue'
      }[purpose] || 'badge-system';
      return `<span class="participant-badge ${badgeClass}">${name}</span>`;
    }

    // ===== Event Listeners =====
    $('fetchBtn').addEventListener('click', fetchConversations);

    // ===== Initialize App =====
    (function init() {
      console.log('Initializing Conversation Explorer...');
      const today = new Date();
      const oneWeekAgo = new Date();
      oneWeekAgo.setDate(today.getDate() - 7);
      $('fromDate').value = oneWeekAgo.toISOString().slice(0, 10);
      $('toDate').value = today.toISOString().slice(0, 10);
      initAuth();
    })();
  </script>
</body>
</html>
