<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quick Capacity</title>

  <!-- Charts (no APIs; just a CDN for drawing) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root{
      /* Teal + white */
      --primary-color:#14b8a6;         /* teal */
      --secondary-color:#0f766e;       /* deep teal */
      --border-color:#DEE2E6;
      --light-bg:#F8F9FA;
      --card-bg:#FFFFFF;
      --text-color:#0f172a;
      --text-light:#64748b;
      --pill:#e6fffb;
      --danger:#dc2626;
      --warn:#f59e0b;
      --ok:#16a34a;
    }

    body, h1, h2, h3, h4, h5, h6, p, div, span, label, button, input, select, textarea, th, td, li, ul, ol, details, summary, pre, code{
      font-family:'Aptos','Segoe UI',Arial,sans-serif;
    }

    body{
      margin:20px;
      padding:20px;
      max-width:1400px;
      background:var(--light-bg);
      color:var(--text-color);
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:16px;
      margin-bottom:12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .logoMark{
      width:44px;height:44px;border-radius:12px;
      background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
      box-shadow:0 6px 18px rgba(20,184,166,.25);
      display:flex;align-items:center;justify-content:center;
      color:white;font-weight:800;
      user-select:none;
    }

    h1{margin:0;font-size:26px;letter-spacing:.2px}
    .muted{color:var(--text-light)}
    .pill{
      display:inline-block;background:var(--pill);
      border:1px solid var(--border-color);
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      color:var(--secondary-color);
      font-weight:700;
      white-space:nowrap;
    }

    .card{
      background:var(--card-bg);
      border:1px solid var(--border-color);
      border-radius:12px;
      padding:24px;
      margin-top:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.08);
    }

    label{display:block;font-weight:600;margin-bottom:6px}
    select,input,button{
      padding:10px;
      border:1px solid var(--border-color);
      border-radius:8px;
      background:var(--card-bg);
      font-size:14px;
      font-family:'Aptos','Segoe UI',Arial,sans-serif;
    }
    input[type="file"]{padding:8px}
    button{
      background:var(--primary-color);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      transition:background .2s;
    }
    button:hover{background:var(--secondary-color)}
    button.secondary{
      background:var(--secondary-color);
    }
    button.ghost{
      background:#fff;
      color:var(--secondary-color);
      border:2px solid var(--primary-color);
    }
    button.ghost:hover{
      background:var(--pill);
    }
    button:disabled{
      background:var(--text-light);
      cursor:not-allowed;
      opacity:.65;
    }

    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:20px 24px;
      align-items:start;
    }

    .inline{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:16px;
      align-items:center;
    }
    .inline span{color:var(--text-light)}

    .full-width-btn{
      width:100%;
      padding:14px 18px;
      font-size:16px;
      margin-top:12px;
    }

    .stats{
      display:flex;
      gap:16px;
      margin:16px 0 0;
      flex-wrap:wrap;
    }
    .stat-card{
      flex:1;
      min-width:200px;
      border:1px solid var(--border-color);
      border-radius:10px;
      padding:16px;
      text-align:center;
      background:var(--card-bg);
    }
    .stat-number{
      font-size:22px;
      color:var(--secondary-color);
      font-weight:800;
    }
    .stat-label{color:var(--text-light);font-weight:600;font-size:13px}

    .tabs{display:flex;gap:12px;flex-wrap:wrap}
    .tab-button{
      padding:10px 16px;
      background:#fff;
      border:2px solid var(--primary-color);
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      color:var(--secondary-color);
      transition:background .2s, color .2s;
    }
    .tab-button:hover{background:var(--pill)}
    .tab-button.active{
      background:var(--primary-color);
      color:#fff;
    }
    .tab-content{display:none}
    .tab-content.active{display:block}

    .help-text{
      background:#f8f9fa;
      border-left:3px solid var(--primary-color);
      padding:12px;
      margin:12px 0;
      font-size:14px;
    }
    .help-text code{
      background:var(--light-bg);
      padding:2px 6px;
      border-radius:6px;
      font-family:ui-monospace,Consolas,Menlo,monospace;
      font-size:12px;
    }

    .grid-2{
      display:grid;
      grid-template-columns:1.1fr .9fr;
      gap:20px;
    }
    @media (max-width: 980px){
      .grid-2{grid-template-columns:1fr}
    }

    .table-wrap{
      overflow:auto;
      border:1px solid var(--border-color);
      border-radius:12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead th{
      position:sticky; top:0;
      background:var(--primary-color);
      color:#fff;
      text-align:left;
      padding:10px 12px;
      font-weight:800;
    }
    tbody td{
      border-bottom:1px solid var(--border-color);
      padding:10px 12px;
      vertical-align:top;
      background:#fff;
    }
    tbody tr:hover td{background:#fbfffe}
    .right{text-align:right}
    .badge{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-weight:800;
      font-size:12px;
      border:1px solid var(--border-color);
      background:#fff;
    }
    .badge.ok{color:var(--ok); border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.06)}
    .badge.warn{color:var(--warn); border-color: rgba(245,158,11,.25); background: rgba(245,158,11,.08)}
    .badge.danger{color:var(--danger); border-color: rgba(220,38,38,.25); background: rgba(220,38,38,.07)}

    .notice{
      border:2px solid var(--primary-color);
      border-radius:12px;
      padding:14px 16px;
      margin-top:14px;
      background:transparent;
    }
    .notice strong{color:var(--secondary-color)}
    .kpiRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .kpiChip{
      border:1px solid var(--border-color);
      background:#fff;
      border-radius:999px;
      padding:6px 10px;
      font-weight:800;
      font-size:12px;
    }

    .small{font-size:12px}
    .dangerText{color:var(--danger);font-weight:800}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="brand">
      <div class="logoMark">QC</div>
      <div>
        <h1>Quick Capacity</h1>
        <div class="muted">Capacity maths without the “AI magic”. (Your overtime calculator won’t unionise.)</div>
      </div>
    </div>
    <div class="pill">Teal • White • Aptos</div>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab-button active" data-tab="tab-planner">Planner</button>
      <button class="tab-button" data-tab="tab-health">Health Check (Overtime)</button>
      <button class="tab-button" data-tab="tab-guide">How to Use</button>
    </div>
  </div>

  <!-- ===================== PLANNER TAB ===================== -->
  <div id="tab-planner" class="tab-content active">
    <div class="card">
      <h2 style="margin:0 0 10px;">1) Inputs</h2>
      <div class="muted">Upload your interval forecast, choose your interval length, tweak volume, and calculate SL/ASA/ABD & required agents.</div>

      <div class="controls" style="margin-top:14px;">
        <div>
          <label>Interval granularity</label>
          <select id="intervalSelect">
            <option value="15">15 minutes</option>
            <option value="30" selected>30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60">60 minutes</option>
            <option value="1440">Daily</option>
          </select>
          <div class="help-text small" style="margin-top:10px;">
            If your upload is already interval-based, we’ll align it. If it’s messy, we’ll still try not to cry.
          </div>
        </div>

        <div>
          <label>Forecast upload (CSV)</label>
          <input id="forecastFile" type="file" accept=".csv"/>
          <div class="muted small" style="margin-top:8px;">
            Expected columns: <code>datetime,volume</code> (datetime can be ISO like <code>2025-01-02T09:00:00</code> or <code>2025-01-02 09:00</code>).
          </div>
          <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap;">
            <button class="ghost" id="loadSampleBtn" type="button">Load sample data</button>
            <button class="ghost" id="clearDataBtn" type="button">Clear</button>
          </div>
        </div>

        <div>
          <label>Forecast modifiers</label>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
              <label class="small">± % change</label>
              <input id="pctChange" type="number" step="0.1" value="0" />
              <div class="muted small">e.g. <code>10</code> = +10%, <code>-5</code> = -5%</div>
            </div>
            <div>
              <label class="small">± volume change</label>
              <input id="volChange" type="number" step="1" value="0" />
              <div class="muted small">Adds/subtracts per interval</div>
            </div>
          </div>
          <button id="applyModsBtn" class="full-width-btn" type="button">Apply modifiers to forecast</button>
        </div>
      </div>

      <hr style="border:none;border-top:1px solid var(--border-color);margin:18px 0">

      <div class="controls">
        <div>
          <h3 style="margin:0 0 10px;">Service assumptions</h3>

          <label for="aht">AHT (seconds)</label>
          <input id="aht" type="number" min="1" step="1" value="300"/>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <div>
              <label for="slPct">Service Level target (%)</label>
              <input id="slPct" type="number" min="1" max="99.9" step="0.1" value="80"/>
            </div>
            <div>
              <label for="slSecs">Service Level time (seconds)</label>
              <input id="slSecs" type="number" min="1" step="1" value="120"/>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <div>
              <label for="shrinkPct">Shrinkage / offline time (%)</label>
              <input id="shrinkPct" type="number" min="0" max="60" step="0.1" value="10"/>
            </div>
            <div>
              <label for="occCap">Occupancy cap (%)</label>
              <input id="occCap" type="number" min="50" max="99.9" step="0.1" value="85"/>
            </div>
          </div>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;">
            <div>
              <label for="patience">Customer patience (seconds) <span class="muted small">(optional)</span></label>
              <input id="patience" type="number" min="0" step="1" value="0"/>
              <div class="muted small">Used for a simple ABD estimate (not Erlang-A). Set 0 to ignore.</div>
            </div>
            <div>
              <label for="maxAgents">Max agents to search</label>
              <input id="maxAgents" type="number" min="1" step="1" value="500"/>
              <div class="muted small">Safety cap for calculations</div>
            </div>
          </div>

          <button id="calcBtn" class="full-width-btn" type="button">Calculate requirements</button>
          <div id="plannerMsg" class="muted" style="margin-top:10px;"></div>
        </div>

        <div>
          <h3 style="margin:0 0 10px;">Calculated forecast</h3>
          <div class="notice">
            <div><strong>What you’ll see:</strong> interval volume, required agents, occupancy, SL, ASA and an ABD estimate.</div>
            <div class="kpiRow">
              <div class="kpiChip">Erlang C for SL/ASA</div>
              <div class="kpiChip">Shrinkage + occupancy cap</div>
              <div class="kpiChip">ABD estimate (patience-based)</div>
            </div>
          </div>

          <div class="stats">
            <div class="stat-card">
              <div class="stat-number" id="kpiIntervals">0</div>
              <div class="stat-label">Intervals loaded</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="kpiTotalVol">0</div>
              <div class="stat-label">Total volume</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="kpiPeakReq">-</div>
              <div class="stat-label">Peak agents required</div>
            </div>
          </div>

          <div class="card" style="padding:16px;margin-top:16px;">
            <h4 style="margin:0 0 10px;">Hourly staffing vs requirement</h4>
            <canvas id="reqChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">2) Interval output</h2>
        <div class="muted small">Tip: daily view is great for exec decks. Interval view is great for reality.</div>
      </div>

      <div class="table-wrap" style="margin-top:14px;">
        <table>
          <thead>
            <tr>
              <th>Interval</th>
              <th class="right">Volume</th>
              <th class="right">Agents Required</th>
              <th class="right">Occupancy</th>
              <th class="right">SL</th>
              <th class="right">ASA</th>
              <th class="right">ABD (est.)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="outRows">
            <tr><td colspan="8" class="muted">No data yet. Upload a forecast or load the sample.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="muted small" style="margin-top:10px;">
        <strong>ABD note:</strong> This is a simple estimate using your “patience” input and calculated ASA (not a full abandonment model). If you need Erlang-A later, we can upgrade.
      </div>
    </div>
  </div>

  <!-- ===================== HEALTH CHECK TAB ===================== -->
  <div id="tab-health" class="tab-content">
    <div class="card">
      <h2 style="margin:0 0 10px;">Health Check (Overtime)</h2>
      <div class="muted">Compare required agents vs scheduled agents to spot understaffing and estimate overtime by interval.</div>

      <div class="controls" style="margin-top:14px;">
        <div>
          <h3 style="margin:0 0 10px;">Scheduled staffing input</h3>

          <label>Option A: Constant scheduled agents</label>
          <input id="schedConst" type="number" min="0" step="1" value="10"/>
          <div class="muted small" style="margin-top:6px;">Applies to every interval</div>

          <div style="height:12px"></div>

          <label>Option B: Upload schedule CSV <span class="muted small">(optional)</span></label>
          <input id="scheduleFile" type="file" accept=".csv"/>
          <div class="muted small" style="margin-top:8px;">
            Expected columns: <code>datetime,agents</code> aligned to your chosen interval length.
          </div>

          <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
            <button class="ghost" id="useConstBtn" type="button">Use constant schedule</button>
            <button class="ghost" id="clearScheduleBtn" type="button">Clear schedule upload</button>
          </div>
        </div>

        <div>
          <h3 style="margin:0 0 10px;">Overtime rules</h3>
          <label>Overtime rounding</label>
          <select id="otRounding">
            <option value="0">No rounding</option>
            <option value="0.25" selected>Round to 15 mins</option>
            <option value="0.5">Round to 30 mins</option>
            <option value="1">Round to 60 mins</option>
          </select>

          <label style="margin-top:12px;">Max overtime per agent (hours) <span class="muted small">(optional)</span></label>
          <input id="maxOtPerAgent" type="number" min="0" step="0.25" value="0"/>
          <div class="muted small" style="margin-top:6px;">
            If set, we’ll also show how many agents you’d need to cover the overtime hours (rough estimate).
          </div>

          <button id="runHealthBtn" class="full-width-btn" type="button">Run health check</button>
          <div id="healthMsg" class="muted" style="margin-top:10px;"></div>
        </div>

        <div>
          <h3 style="margin:0 0 10px;">Summary</h3>
          <div class="stats">
            <div class="stat-card">
              <div class="stat-number" id="kpiUnderHours">0</div>
              <div class="stat-label">Overtime hours needed</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="kpiWorstGap">0</div>
              <div class="stat-label">Worst interval gap (agents)</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="kpiOtAgents">-</div>
              <div class="stat-label">Agents needed (est.)</div>
            </div>
          </div>

          <div class="card" style="padding:16px;margin-top:16px;">
            <h4 style="margin:0 0 10px;">Scheduled vs required</h4>
            <canvas id="healthChart" height="120"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 12px;">Interval overtime detail</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Interval</th>
              <th class="right">Required</th>
              <th class="right">Scheduled</th>
              <th class="right">Gap</th>
              <th class="right">Overtime hours</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="healthRows">
            <tr><td colspan="6" class="muted">Run the health check after calculating requirements.</td></tr>
          </tbody>
        </table>
      </div>
      <div class="muted small" style="margin-top:10px;">
        Overtime hours = <code>max(0, Required - Scheduled) × intervalHours</code> (then rounded based on your setting).
      </div>
    </div>
  </div>

  <!-- ===================== GUIDE TAB ===================== -->
  <div id="tab-guide" class="tab-content">
    <div class="card">
      <h2 style="margin:0 0 12px;">How to use Quick Capacity</h2>

      <div class="help-text">
        <strong>CSV format</strong>
        <ul>
          <li><strong>Forecast CSV:</strong> <code>datetime,volume</code></li>
          <li><strong>Schedule CSV (optional):</strong> <code>datetime,agents</code></li>
        </ul>
        Datetime can be <code>YYYY-MM-DD HH:MM</code> or ISO. We treat it as local time.
      </div>

      <div class="help-text">
        <strong>Workflow</strong>
        <ol>
          <li>Pick interval granularity (15/30/45/60/day).</li>
          <li>Upload forecast (or load sample), optionally apply modifiers.</li>
          <li>Set AHT + targets, then click <em>Calculate requirements</em>.</li>
          <li>Go to <em>Health Check</em>, set scheduled agents (constant or upload), run health check.</li>
        </ol>
      </div>

      <div class="help-text">
        <strong>Metrics</strong>
        <ul>
          <li><strong>SL</strong> and <strong>ASA</strong> are calculated using Erlang C.</li>
          <li><strong>Occupancy</strong> is <code>offeredLoad / agents</code> and we enforce your occupancy cap when finding the required agents.</li>
          <li><strong>ABD</strong> is a simple estimate based on patience vs ASA (so it’s directionally useful, not gospel).</li>
        </ul>
      </div>

      <div class="help-text">
        <strong>GitHub Pages tip</strong>
        <p class="muted">
          Put this file in the repo root as <code>index.html</code>, then enable GitHub Pages (Deploy from branch). That’s it.
        </p>
      </div>
    </div>
  </div>

  <script>
    // ===================== State =====================
    const state = {
      intervalMins: 30,
      rawForecast: [],     // {dt: Date, volume: number}
      forecast: [],        // modified/normalised to interval
      results: [],         // per-interval computed outputs
      schedule: null,      // Map(key -> agents) if uploaded
      reqChart: null,
      healthChart: null
    };

    const $ = (id) => document.getElementById(id);

    // ===================== Tabs =====================
    function setupTabs(){
      const buttons = document.querySelectorAll('.tab-button');
      const contents = document.querySelectorAll('.tab-content');
      buttons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          buttons.forEach(b=>b.classList.remove('active'));
          contents.forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(btn.dataset.tab).classList.add('active');
        });
      });
    }

    // ===================== CSV Parsing =====================
    function parseCSV(text){
      const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      if(!lines.length) return [];
      const header = lines[0].split(',').map(h=>h.trim().toLowerCase());
      const idxDt = header.findIndex(h=>['datetime','date','time','timestamp'].includes(h));
      const idxVol = header.findIndex(h=>['volume','contacts','calls','offered','demand'].includes(h));
      const idxAgents = header.findIndex(h=>['agents','staff','scheduled'].includes(h));

      const out = [];
      for(let i=1;i<lines.length;i++){
        const parts = lines[i].split(',').map(p=>p.trim());
        const dtStr = parts[idxDt] ?? parts[0];
        const dt = parseDateLoose(dtStr);
        if(!dt) continue;

        const volume = idxVol>=0 ? Number(parts[idxVol]) : NaN;
        const agents = idxAgents>=0 ? Number(parts[idxAgents]) : NaN;

        out.push({ dt, volume, agents });
      }
      return out;
    }

    function parseDateLoose(s){
      if(!s) return null;
      // Try native parse first
      let d = new Date(s);
      if(!isNaN(+d)) return d;

      // Try "YYYY-MM-DD HH:MM"
      const m = s.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})(?::(\d{2}))?$/);
      if(m){
        const [_,Y,M,D,h,mm,ss] = m;
        d = new Date(Number(Y), Number(M)-1, Number(D), Number(h), Number(mm), Number(ss||0));
        if(!isNaN(+d)) return d;
      }
      return null;
    }

    function keyForInterval(dt, intervalMins){
      const ms = dt.getTime();
      const bucket = Math.floor(ms / (intervalMins*60*1000)) * (intervalMins*60*1000);
      return bucket;
    }

    function normaliseForecastToInterval(rows, intervalMins){
      // Sum volumes into buckets
      const m = new Map();
      rows.forEach(r=>{
        const k = keyForInterval(r.dt, intervalMins);
        const v = Number(r.volume);
        if(!isFinite(v)) return;
        m.set(k, (m.get(k)||0) + v);
      });
      const out = [...m.entries()]
        .sort((a,b)=>a[0]-b[0])
        .map(([k,vol])=>({ dt: new Date(Number(k)), volume: vol }));
      return out;
    }

    function normaliseScheduleToInterval(rows, intervalMins){
      // If multiple rows per bucket, take average (or last non-null)
      const m = new Map();
      const c = new Map();
      rows.forEach(r=>{
        const k = keyForInterval(r.dt, intervalMins);
        const a = Number(r.agents);
        if(!isFinite(a)) return;
        m.set(k, (m.get(k)||0) + a);
        c.set(k, (c.get(k)||0) + 1);
      });
      const out = new Map();
      for(const [k,sum] of m.entries()){
        out.set(k, sum / (c.get(k)||1));
      }
      return out;
    }

    // ===================== Erlang C =====================
    // Offered load a = lambda * AHT (in Erlangs), where lambda is arrivals per second.
    function erlangCProbWait(a, n){
      if(n <= a) return 1; // unstable
      // Use recursion to avoid huge factorials:
      // sum_{k=0..n-1} (a^k / k!) + (a^n/n!) * (n/(n-a))
      let term = 1; // a^0/0!
      let sum = 1;
      for(let k=1;k<=n-1;k++){
        term *= a / k;
        sum += term;
      }
      // term is now a^(n-1)/(n-1)!
      term *= a / n; // a^n/n!
      const last = term * (n/(n-a));
      const pw = last / (sum + last);
      return Math.max(0, Math.min(1, pw));
    }

    function erlangCASASeconds(a, n, ahtSec){
      if(n <= a) return Infinity;
      const pw = erlangCProbWait(a, n);
      const asa = (pw * ahtSec) / (n - a);
      return asa;
    }

    function erlangCServiceLevel(a, n, ahtSec, tSec){
      if(n <= a) return 0;
      const pw = erlangCProbWait(a, n);
      // SL(t) = 1 - Pw * exp(-(n-a) * (t/AHT))
      const expTerm = Math.exp(-(n - a) * (tSec / ahtSec));
      const sl = 1 - (pw * expTerm);
      return Math.max(0, Math.min(1, sl));
    }

    function findRequiredAgentsForTargets(volume, intervalMins, ahtSec, slTarget, slSecs, occCap, maxAgents){
      const intervalSec = intervalMins * 60;
      const arrivalsPerSec = volume / intervalSec;
      const a = arrivalsPerSec * ahtSec; // Erlangs

      if(volume <= 0 || a <= 0){
        return { agents: 0, a, sl: 1, asa: 0, occ: 0, pw: 0 };
      }

      // Start at ceil(a) and increment
      let n = Math.max(1, Math.ceil(a));
      let best = null;

      for(; n<=maxAgents; n++){
        const occ = a / n;
        if(occ > occCap) continue; // enforce cap

        const sl = erlangCServiceLevel(a, n, ahtSec, slSecs);
        if(sl < slTarget) continue;

        const asa = erlangCASASeconds(a, n, ahtSec);
        const pw = erlangCProbWait(a, n);

        best = { agents: n, a, sl, asa, occ, pw };
        break;
      }

      if(!best){
        // If we can't meet target within maxAgents, return "max" with computed metrics
        const n2 = maxAgents;
        const occ = a / n2;
        const sl = (n2<=a) ? 0 : erlangCServiceLevel(a, n2, ahtSec, slSecs);
        const asa = (n2<=a) ? Infinity : erlangCASASeconds(a, n2, ahtSec);
        const pw = (n2<=a) ? 1 : erlangCProbWait(a, n2);
        best = { agents: n2, a, sl, asa, occ, pw, capped:true };
      }

      return best;
    }

    // Simple ABD estimate (NOT Erlang-A):
    // If patience > 0, and ASA > patience, estimate abandons increasing with how far ASA exceeds patience.
    function estimateABD(asaSec, patienceSec){
      if(!patienceSec || patienceSec <= 0) return null;
      if(!isFinite(asaSec)) return 100;
      if(asaSec <= patienceSec) return 0;

      // Smooth-ish curve: ABD ~ 1 - (patience/ASA) capped
      const abd = (1 - (patienceSec / Math.max(asaSec, 1))) * 100;
      return Math.max(0, Math.min(100, abd));
    }

    // ===================== Planner =====================
    function updatePlannerKPIs(){
      $('kpiIntervals').textContent = state.forecast.length;
      $('kpiTotalVol').textContent = Math.round(state.forecast.reduce((s,r)=>s+r.volume,0));
      const peak = state.results.length ? Math.max(...state.results.map(r=>r.agentsRequired||0)) : null;
      $('kpiPeakReq').textContent = (peak==null) ? '-' : peak;
    }

    function fmtInterval(dt){
      const mins = state.intervalMins;
      if(mins === 1440){
        // daily
        return dt.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'2-digit' });
      }
      return dt.toLocaleString(undefined, { year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    function pct(x){ return (x*100).toFixed(1) + '%'; }

    function renderPlannerTable(){
      const tbody = $('outRows');
      if(!state.results.length){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No results yet. Calculate requirements first.</td></tr>`;
        return;
      }

      const slTarget = Number($('slPct').value)/100;

      tbody.innerHTML = state.results.map(r=>{
        const slOk = r.sl >= slTarget;
        const occOk = r.occ <= (Number($('occCap').value)/100);
        const status = (!slOk || !occOk || r.capped)
          ? {t:'Needs attention', cls:'warn'}
          : {t:'OK', cls:'ok'};

        const abdTxt = (r.abd==null) ? '-' : (r.abd.toFixed(1) + '%');

        return `
          <tr>
            <td>${fmtInterval(r.dt)}</td>
            <td class="right">${Math.round(r.volume)}</td>
            <td class="right">${r.agentsRequired}</td>
            <td class="right">${isFinite(r.occ)?pct(r.occ):'-'}</td>
            <td class="right">${pct(r.sl)}</td>
            <td class="right">${isFinite(r.asa)?Math.round(r.asa)+'s':'∞'}</td>
            <td class="right">${abdTxt}</td>
            <td><span class="badge ${status.cls}">${status.t}</span>${r.capped?` <span class="muted small">(cap)</span>`:''}</td>
          </tr>
        `;
      }).join('');
    }

    function buildReqChart(){
      const ctx = $('reqChart');
      const labels = state.results.map(r=> {
        if(state.intervalMins===1440) return r.dt.toLocaleDateString(undefined,{month:'short',day:'2-digit'});
        return r.dt.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      });
      const data = state.results.map(r=>r.agentsRequired);

      if(state.reqChart) state.reqChart.destroy();
      state.reqChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Agents required',
            data
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true }
          },
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    function calculateRequirements(){
      const msg = $('plannerMsg');
      msg.textContent = '';

      if(!state.forecast.length){
        msg.innerHTML = `<span class="dangerText">No forecast loaded.</span> Upload a CSV or click “Load sample data”.`;
        return;
      }

      const intervalMins = state.intervalMins;
      const ahtSec = Number($('aht').value);
      const slTarget = Number($('slPct').value)/100;
      const slSecs = Number($('slSecs').value);
      const shrink = Number($('shrinkPct').value)/100;
      const occCap = Number($('occCap').value)/100;
      const patience = Number($('patience').value);
      const maxAgents = Math.max(1, Number($('maxAgents').value));

      if(!isFinite(ahtSec) || ahtSec<=0){
        msg.innerHTML = `<span class="dangerText">AHT must be > 0.</span>`;
        return;
      }

      // Compute per interval
      state.results = state.forecast.map(row=>{
        const base = findRequiredAgentsForTargets(
          row.volume, intervalMins, ahtSec, slTarget, slSecs, occCap, maxAgents
        );

        // Apply shrinkage uplift
        // Required paid agents = required productive / (1 - shrink)
        const productive = base.agents;
        const paid = (productive<=0) ? 0 : Math.ceil(productive / Math.max(1 - shrink, 0.0001));

        const abd = estimateABD(base.asa, patience);

        return {
          dt: row.dt,
          volume: row.volume,
          agentsRequired: paid,
          productiveAgents: productive,
          sl: base.sl,
          asa: base.asa,
          occ: base.occ,
          abd,
          capped: !!base.capped
        };
      });

      updatePlannerKPIs();
      renderPlannerTable();
      buildReqChart();

      const cappedCount = state.results.filter(r=>r.capped).length;
      msg.textContent = cappedCount
        ? `Calculated with ${cappedCount} interval(s) hitting the “max agents” cap. Increase the cap if you want it to search higher.`
        : `Done. Requirements calculated across ${state.results.length} interval(s).`;
    }

    // ===================== Modifiers & Loading =====================
    function applyModifiers(){
      if(!state.rawForecast.length && !state.forecast.length){
        $('plannerMsg').innerHTML = `<span class="dangerText">Nothing to modify.</span> Load a forecast first.`;
        return;
      }

      const pctChange = Number($('pctChange').value) || 0;
      const volChange = Number($('volChange').value) || 0;

      // Apply to current forecast (not raw), so you can stack changes if you want
      const base = state.forecast.length ? state.forecast : state.rawForecast;
      const factor = 1 + (pctChange/100);

      state.forecast = base.map(r=>({
        dt: r.dt,
        volume: Math.max(0, (r.volume * factor) + volChange)
      }));

      state.results = [];
      updatePlannerKPIs();
      renderPlannerTable();
      if(state.reqChart) state.reqChart.destroy();

      $('plannerMsg').textContent = `Applied modifiers: ${pctChange}% and ${volChange} per interval. Recalculate requirements.`;
    }

    function clearAll(){
      state.rawForecast = [];
      state.forecast = [];
      state.results = [];
      state.schedule = null;

      $('forecastFile').value = '';
      $('scheduleFile').value = '';
      $('plannerMsg').textContent = '';
      $('healthMsg').textContent = '';

      updatePlannerKPIs();
      renderPlannerTable();
      $('healthRows').innerHTML = `<tr><td colspan="6" class="muted">Run the health check after calculating requirements.</td></tr>`;

      if(state.reqChart) { state.reqChart.destroy(); state.reqChart=null; }
      if(state.healthChart) { state.healthChart.destroy(); state.healthChart=null; }

      $('kpiUnderHours').textContent = '0';
      $('kpiWorstGap').textContent = '0';
      $('kpiOtAgents').textContent = '-';
    }

    function loadSample(){
      // Simple 1-day sample starting at 08:00, with a lunchtime spike
      const intervalMins = state.intervalMins;
      const start = new Date();
      start.setHours(8,0,0,0);

      const points = [];
      const n = (intervalMins===1440) ? 7 : Math.floor((12*60)/intervalMins); // 12h sample for intraday
      for(let i=0;i<n;i++){
        const dt = new Date(start.getTime() + i*intervalMins*60*1000);
        let base = 10;
        const hour = dt.getHours() + dt.getMinutes()/60;
        if(hour >= 10 && hour < 12) base = 22;
        if(hour >= 12 && hour < 14) base = 35;
        if(hour >= 14 && hour < 16) base = 26;
        if(hour >= 16 && hour < 18) base = 18;
        const jitter = (Math.random()*6)-3;
        points.push({ dt, volume: Math.max(0, base + jitter) });
      }

      state.rawForecast = points;
      state.forecast = normaliseForecastToInterval(points, intervalMins);
      state.results = [];
      updatePlannerKPIs();
      renderPlannerTable();
      if(state.reqChart) { state.reqChart.destroy(); state.reqChart=null; }
      $('plannerMsg').textContent = 'Loaded sample forecast. Click “Calculate requirements”.';
    }

    // ===================== Health Check =====================
    function getScheduledAgentsForInterval(dt){
      const k = keyForInterval(dt, state.intervalMins);
      if(state.schedule && state.schedule.has(k)){
        return state.schedule.get(k);
      }
      return Number($('schedConst').value) || 0;
    }

    function roundHours(hours, rounding){
      if(!rounding || rounding <= 0) return hours;
      return Math.ceil(hours / rounding) * rounding;
    }

    function runHealthCheck(){
      const msg = $('healthMsg');
      msg.textContent = '';

      if(!state.results.length){
        msg.innerHTML = `<span class="dangerText">No requirements to compare.</span> Go to Planner and calculate requirements first.`;
        return;
      }

      const intervalHours = state.intervalMins / 60;
      const rounding = Number($('otRounding').value) || 0;
      const maxOtPerAgent = Number($('maxOtPerAgent').value) || 0;

      let totalUnderHours = 0;
      let worstGap = 0;

      const rows = state.results.map(r=>{
        const required = r.agentsRequired || 0;
        const scheduled = getScheduledAgentsForInterval(r.dt);
        const gap = required - scheduled;

        worstGap = Math.max(worstGap, gap);

        let otHours = 0;
        if(gap > 0){
          otHours = gap * intervalHours;
          otHours = roundHours(otHours, rounding);
          totalUnderHours += otHours;
        }

        const status = gap > 0 ? {t:'Under', cls:'danger'} :
                       gap === 0 ? {t:'Even', cls:'ok'} :
                                  {t:'Over', cls:'warn'};

        return { dt:r.dt, required, scheduled, gap, otHours, status };
      });

      // Summary KPIs
      $('kpiUnderHours').textContent = totalUnderHours.toFixed(2);
      $('kpiWorstGap').textContent = Math.max(0, Math.round(worstGap));

      let otAgents = '-';
      if(maxOtPerAgent > 0){
        otAgents = totalUnderHours > 0 ? Math.ceil(totalUnderHours / maxOtPerAgent) : 0;
      }
      $('kpiOtAgents').textContent = otAgents;

      // Render table
      $('healthRows').innerHTML = rows.map(r=>`
        <tr>
          <td>${fmtInterval(r.dt)}</td>
          <td class="right">${r.required}</td>
          <td class="right">${r.scheduled.toFixed(1).replace(/\.0$/,'')}</td>
          <td class="right">${r.gap.toFixed(1).replace(/\.0$/,'')}</td>
          <td class="right">${r.otHours ? r.otHours.toFixed(2) : '0.00'}</td>
          <td><span class="badge ${r.status.cls}">${r.status.t}</span></td>
        </tr>
      `).join('');

      // Chart
      const labels = rows.map(r=>{
        if(state.intervalMins===1440) return r.dt.toLocaleDateString(undefined,{month:'short',day:'2-digit'});
        return r.dt.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
      });
      const req = rows.map(r=>r.required);
      const sch = rows.map(r=>r.scheduled);

      if(state.healthChart) state.healthChart.destroy();
      state.healthChart = new Chart($('healthChart'), {
        type: 'line',
        data: {
          labels,
          datasets: [
            { label: 'Required', data: req, tension: 0.25 },
            { label: 'Scheduled', data: sch, tension: 0.25 }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: { y: { beginAtZero: true } }
        }
      });

      msg.textContent = `Health check complete. Total overtime hours needed: ${totalUnderHours.toFixed(2)}.`;
    }

    // ===================== Event wiring =====================
    function wireEvents(){
      $('intervalSelect').addEventListener('change', ()=>{
        state.intervalMins = Number($('intervalSelect').value);
        // Re-normalise current raw forecast/schedule
        if(state.rawForecast.length){
          state.forecast = normaliseForecastToInterval(state.rawForecast, state.intervalMins);
          state.results = [];
        }
        if(state.schedule && state.schedule.__rawRows){
          state.schedule = normaliseScheduleToInterval(state.schedule.__rawRows, state.intervalMins);
          state.schedule.__rawRows = state.schedule.__rawRows; // keep reference if needed
        }
        updatePlannerKPIs();
        renderPlannerTable();
        if(state.reqChart) { state.reqChart.destroy(); state.reqChart=null; }
        $('plannerMsg').textContent = 'Interval updated. Recalculate requirements.';
      });

      $('forecastFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        const rows = parseCSV(text);

        // Convert to forecast rows (ignore agents col)
        const fc = rows
          .filter(r=>isFinite(r.volume))
          .map(r=>({ dt:r.dt, volume:Number(r.volume) }));

        state.rawForecast = fc;
        state.forecast = normaliseForecastToInterval(fc, state.intervalMins);
        state.results = [];

        updatePlannerKPIs();
        renderPlannerTable();
        if(state.reqChart) { state.reqChart.destroy(); state.reqChart=null; }

        $('plannerMsg').textContent = `Loaded forecast: ${state.forecast.length} interval(s). Click “Calculate requirements”.`;
      });

      $('scheduleFile').addEventListener('change', async (e)=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const text = await file.text();
        const rows = parseCSV(text).filter(r=>isFinite(r.agents));

        const sched = normaliseScheduleToInterval(rows, state.intervalMins);
        // Keep raw for possible re-normalisation on interval changes
        sched.__rawRows = rows;
        state.schedule = sched;

        $('healthMsg').textContent = `Loaded schedule upload (${sched.size} interval(s)). Run the health check.`;
      });

      $('applyModsBtn').addEventListener('click', applyModifiers);
      $('calcBtn').addEventListener('click', calculateRequirements);

      $('loadSampleBtn').addEventListener('click', loadSample);
      $('clearDataBtn').addEventListener('click', clearAll);

      $('useConstBtn').addEventListener('click', ()=>{
        state.schedule = null;
        $('scheduleFile').value = '';
        $('healthMsg').textContent = 'Using constant schedule input.';
      });

      $('clearScheduleBtn').addEventListener('click', ()=>{
        state.schedule = null;
        $('scheduleFile').value = '';
        $('healthMsg').textContent = 'Cleared schedule upload.';
      });

      $('runHealthBtn').addEventListener('click', runHealthCheck);
    }

    // ===================== Init =====================
    (function init(){
      setupTabs();
      wireEvents();
      state.intervalMins = Number($('intervalSelect').value);
      updatePlannerKPIs();
    })();
  </script>
</body>
</html>
