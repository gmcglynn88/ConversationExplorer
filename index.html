<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Genesys Conversation Explorer</title>
  <style>
    body {
      font-family: Aptos, 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      padding: 20px;
    }
    #logo-container { text-align: center; margin-bottom: 20px; }
    #logo { width: 300px; }
    label { margin-top: 10px; display: block; font-weight: bold; }
    select, input, button { margin-top: 5px; padding: 8px; width: 100%; max-width: 300px; }
    #statusMessage { margin-top: 20px; color: green; }
    #errorMessage { margin-top: 10px; color: #c1272d; }
    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-top: 12px; }
    .muted { color: #6b7280; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid #e5e7eb; border-radius:999px; font-size:12px; }
    table { width:100%; border-collapse: collapse; }
    th, td { border-bottom:1px solid #e5e7eb; padding:8px 6px; text-align:left; vertical-align:top; }
    details { background:#fff; border:1px solid #e5e7eb; border-radius: 12px; padding:10px 12px; margin:10px 0; }
    details>summary { cursor:pointer; font-weight:600; }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>Conversation Explorer</h1>
  <details class="card"><summary><strong>Debug</strong> (click to expand)</summary>
    <div>Computed Redirect URI: <code id="dbgRedirect"></code></div>
    <div>Authorize URL: <code id="dbgAuth"></code></div>
    <div>Origin: <code id="dbgOrigin"></code></div>
  </details>

  <div class="row">
    <div>
      <label for="clientId">OAuth Client ID</label>
      <input id="clientId" type="text" value="bbc89753-462b-493d-ab94-4778af9e7d4d" readonly />
    </div>
    <div>
      <label for="redirectUri">Redirect URI</label>
      <input id="redirectUri" type="text" value="" readonly />
    </div>
    <div>
      <label>&nbsp;</label>
      <button id="logoutBtn">Sign out</button>
    </div>
    <div>
      <label>Auth</label>
      <span id="authInfo" class="pill">Not signed in</span>
    </div>
  </div>

  <div class="row">
    <div>
      <label for="agentSelect">Agent</label>
      <select id="agentSelect"><option>Loading users…</option></select>
      <input id="agentFilter" type="text" placeholder="Filter users by name/email" />
      <input id="agentId" type="text" placeholder="Selected agentId" readonly />
    </div>
    <div>
      <label for="fromDate">From</label>
      <input id="fromDate" type="date" />
      <label for="toDate">To</label>
      <input id="toDate" type="date" />
      <div style="margin-top:10px;">
        <button id="fetchBtn">Fetch Conversations</button>
        <button id="exportBtn">Export CSV</button>
      </div>
    </div>
  </div>

  <div id="statusMessage"></div>
  <div id="errorMessage"></div>

  <div class="card" style="margin-top:18px;">
    <h2>Results</h2>
    <div id="results"></div>
  </div>

  <script>
    const state = {
      token: null,
      tokenExpiry: 0,
      regionHost: 'https://api.mypurecloud.ie',
      loginHost: 'https://login.mypurecloud.ie',
      conversations: [],
      users: [],
      selectedAgent: null
    };

    const $ = (id) => document.getElementById(id);
    const fmt = (d) => new Date(d).toLocaleString();

    function setStatus(msg, isError=false) {
      $('statusMessage').textContent = isError ? '' : msg || '';
      $('errorMessage').textContent = isError ? (msg || '') : '';
    }

    function buildOAuthUrl() {
      const clientId = $('clientId').value.trim();
      // Always use the *actual* URL the app is running at (avoids copy/paste mismatch)
      const redirectUri = window.location.origin + window.location.pathname;
      $('redirectUri').value = redirectUri;
      const url = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;
      // Debug surface
      $('dbgRedirect').textContent = redirectUri;
      $('dbgOrigin').textContent = window.location.origin;
      $('dbgAuth').textContent = url;
      return url;
    }&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;
    }

    function initAuth() {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token = params.get('access_token');
      if (!token) {
        location.href = buildOAuthUrl();
        return false;
      }
      state.token = token;
      const expiresIn = parseInt(params.get('expires_in')||'0', 10);
      state.tokenExpiry = Date.now() + (expiresIn*1000);
      history.replaceState(null, '', location.pathname + location.search);
      $('authInfo').textContent = 'Authenticated';
      return true;
    }

    async function api(path) {
      if (!state.token) throw new Error('Not authenticated');
      const res = await fetch(`${state.regionHost}${path}`, {
        headers: { 'Authorization': `Bearer ${state.token}` }
      });
      if (!res.ok) throw new Error(`${res.status}: ${res.statusText}`);
      return res.json();
    }

    async function fetchAllUsers() {
      try {
        setStatus('Loading users…');
        const pageSize = 100; let pageNumber = 1; let all = [];
        while (true) {
          const data = await api(`/api/v2/users?pageSize=${pageSize}&pageNumber=${pageNumber}`);
          const batch = (data && data.entities) || [];
          all = all.concat(batch);
          if (!data || !data.nextUri || batch.length < pageSize) break;
          pageNumber++;
        }
        state.users = all.map(u => ({ id: u.id, name: u.name, email: (u.email||'') }));
        populateUserSelect(state.users);
        setStatus(`Loaded ${state.users.length} user(s).`);
      } catch (e) { setStatus(e.message, true); $('agentSelect').innerHTML = '<option>Failed to load users</option>'; }
    }

    function populateUserSelect(users) {
      const sel = $('agentSelect');
      sel.innerHTML = users.map(u => `<option value="${u.id}">${u.name} ${u.email?`<${u.email}>`:''}</option>`).join('');
      sel.onchange = () => {
        const id = sel.value; const u = users.find(x => x.id === id);
        state.selectedAgent = u || null;
        $('agentId').value = u ? `${u.id}  ·  ${u.name}` : '';
      };
      if (users.length) { sel.value = users[0].id; sel.onchange(); }
    }

    $('agentFilter').addEventListener('input', () => {
      const q = $('agentFilter').value.trim().toLowerCase();
      const filtered = !q ? state.users : state.users.filter(u => (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q));
      populateUserSelect(filtered);
    });

    async function fetchConversations() {
      try {
        setStatus('Fetching conversations...');
        if (!state.selectedAgent) throw new Error('Select an agent first.');
        const from = $('fromDate').value;
        const to = $('toDate').value || $('fromDate').value;
        const interval = `${from}T00:00:00/${to}T23:59:59`;

        const body = {
          interval,
          order: 'asc',
          orderBy: 'conversationStart',
          segmentFilters: [{
            type: 'and',
            predicates: [{ type: 'dimension', dimension: 'userId', operator: 'matches', value: state.selectedAgent.id }]
          }]
        };

        const res = await fetch(`${state.regionHost}/api/v2/analytics/conversations/details/query`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error(`${res.statusText}`);
        const data = await res.json();
        renderResults(data.conversations || []);
        setStatus(`Fetched ${data.conversations?.length || 0} conversation(s).`);
      } catch (e) { setStatus(e.message, true); }
    }

    function renderResults(items) {
      const results = $('results');
      if (!items.length) { results.innerHTML = '<p class="muted">No conversations found.</p>'; return; }
      results.innerHTML = items.map(c => `<details><summary>${c.conversationId} (${fmt(c.conversationStart)} - ${fmt(c.conversationEnd)})</summary><pre>${JSON.stringify(c,null,2)}</pre></details>`).join('');
    }

    $('fetchBtn').addEventListener('click', fetchConversations);

    (function init() {
      const today = new Date().toISOString().slice(0,10);
      $('fromDate').value = today; $('toDate').value = today;
      const authed = initAuth();
      if (authed) fetchAllUsers();
      // Ensure debug shows values even when token is present
      buildOAuthUrl();
    })();
  </script>
</body>
</html>
